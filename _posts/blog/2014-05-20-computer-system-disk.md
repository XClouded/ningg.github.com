---
layout: post
title: 磁盘和文件系统
description: 计算机上，数据写在磁盘上，那么，磁盘是什么结构？磁盘读写速度有没有瓶颈？
category: computer system
---

##背景

最近在服务器间传送文件，需要监控磁盘IO和网络IO，确定哪一个是瓶颈，并且找出服务器之间`高效传输文件`的方案。

更细节一些的：例如，提高磁盘的转速、改进磁盘接口，当前环境下，哪个有效？

##磁盘

（本文关注的是旋转磁盘，固态硬盘不包含在内。）

开篇有个疑问：要想在服务器间`高效地传输文件`，首先要弄明白的是：文件在哪？好，文件不是凭空想想的，而是实实在在存储在物理介质上的，当前主要是存储于磁盘中。

几个小常识：

* 硬盘尺寸：台式机3.5英寸，笔记本尺寸2.5英寸；

###物理结构

![true-disk](/images/computer-system-disk/true-disk.jpg)

从上图可以看出，磁盘物理上，包含如下几个部分：

1. 盘片：通常包含两个`盘面`，上面覆盖了磁性物质，用于记录数据；
2. 磁头：每个`盘面`对应一个磁头，读取`盘面`上的数据；
3. 主轴马达：带动盘片转动；
4. 机械手臂：调整磁头位置；

备注：所有磁头，任何时刻，都在同一`磁柱`上。

###逻辑结构

磁盘有一个指标叫作`磁盘容量`，它标识了一个磁盘可以存储多少个字节；那好，一个字节过来了，应该存储在哪个地方？*（类比，一位新兵到了，应该到部队中哪个地方去？）*

为避免混乱，方便管理，需要为磁盘设计一个组织方式。*（类比，部队被划分为一个个基本单元：`班`，几个`班`构成一个`排`，几个`排`构成一个`连`......）*


![disk-layer-structure](/images/computer-system-disk/disk-layer-structure.png)


磁盘的组织方式如上图所示，简要说明如下：

1. 磁盘最小的物理单元为`扇区`(sector)，扇区的大小是固定的，通常为 512 bytes；
2. 同一个`盘面`上，同一圆圈上的所有`扇区`组成一个`磁道`(track)，又称`磁轨`；
3. 所有`盘面`上，在对应位置的所有`磁道`组成一个`磁柱`(cylinder)；

将上面的磁盘组织方式对应到实际物理磁盘上，如下图所示：

![disk-logic-structure](/images/computer-system-disk/disk-logic-structure.png)

补充说明：

1. 2009年底，磁盘制造商逐渐推广`扇区`大小为 4096 bytes;
2. 通常，每个`磁道`上`扇区`个数相同，则，外圈的磁道上，扇区分布稀疏。为提升盘片的利用率，产生了`多区记录技术`(multiple zone recording)：相邻的几个磁柱被分割为一个记录区（recording zone），一个记录区中，每个磁柱的每个磁道拥有相同数量的扇区，扇区数由记录区中最里侧的磁道来决定。

###接口

为了读取磁盘中数据，需要一根排线，将磁盘连到电脑上；磁盘连接排线的地方叫接口，接口的传输速度限制了读取磁盘的最大速度。常见的磁盘接口，有IDE、SATA、SCSI。

**IDE接口**：Integrated Drive Electronics，集成电路设备，具有如下特点：

1. 排线较宽；
2. Ultra 133，即理论速度 133MB/s
3. 每条IDE排线，可接2个IDE接口设备，分为master和slave，需要设置跳针；
4. 常用于个人电脑；

**SATA接口**：Serial ATA，具有如下特点：

1. 插槽比IDE小；
2. 每条SATA排线，仅能连接一个SATA接口设备；
3. SATA-1理论速度：150MB/s，SATA-2理论速度：300MB/s，最近的SATA-3理论速度：600MB/s；
4. 常用于个人电脑；

**SCSI接口**：Small Computer System Interface，小型计算机系统接口，具有如下特点：

1. 对应磁盘上，有一个处理器，节省主板上CPU资源；
2. SCSI-3 Ultra 320的理论速度：320MB/s，Ultra 640的理论速度：640MB/s；
3. 常用于服务器、工作站；

###筛选磁盘注意事项

1. 接口类型：IDE？SATA？SCSI？主板上插槽是否支持？
2. 容量：2T？500G？
3. 转速：7200转/min？5400转/min？
4. 磁盘缓冲内存大小：磁盘上此机制，加速文件读取速率；

备注：建议每次正常关机，这样磁盘的机械手臂会回到原位。*（当前已有技术使得磁盘停止旋转后，机械手臂自动回到原位）*

###查看磁盘详情

（查看步骤）

###读写磁盘耗时

读写磁盘所需时间，较为专业的称呼是`磁盘访问时间`，其主要分为：寻道时间、旋转时间、传送时间，具体如下：

1. 寻道时间，`seek time`：机械手臂摆动，将磁头定位到目标扇区所在的磁道上，其耗时是ms级的；
2. 旋转时间，`rotational time`：磁头定位到磁道后，需要等待目标扇区的第一个bit旋转到磁头下；
3. 传送时间，`transfer time`：磁头从目标扇区第一个bit扫描到最后一个bit所需时间；

备注：旋转磁盘的访问时间是ms级别的。

###查询磁盘参数

（出厂参数）

###磁盘IO的基本过程

（DMA）


###测试磁盘读写速度

（doing...）


##磁盘格式化

一块新磁盘放在我面前，怎么往上面写文件呢？要想使用，需要先把磁盘内部的东西整理一下，即进行格式化。具体磁盘格式化包括：

1. 低级格式化：又称，低阶格式化，
2. 分区：
3. 高级格式化：又称，高阶格式化，

###逻辑区块Block

逻辑区块（Block），这个概念很重要，需要单独拎出来说一下。

数据总是要存储在磁盘上的，磁盘的最小物理单元为`扇区`（Sector），通常一个扇区 512 Bytes，磁盘通过磁头读取扇区内的信息，对于一个 10M Bytes的文件，磁头要进行20480次读取（I/O）。

为了克服上述文件读取效率问题，逻辑区块（Block）这一概念就产生了！逻辑区块，是在磁盘格式化为某一种文件系统（File System）时，所指定的`最小存储单元`。这个最小存储单元，是架构在`扇区`之上的（因为`扇区`是磁盘的最小物理存储单元），由多个连续的Sector构成；Block的大小一般为Sector的2的n次方倍。此时，磁头一次读取一个Block，假设格式化时，指定Block为4KB（即由8个512Bytes的Sector组成），那么同样10MB大小的文件，读取时，磁头的读取次数降至2560次，文件的读取效率大大提升了。
通常Block越大，文件读取效率越高。

Block是不是越大越好？不是，因为一个Block最多仅能容纳一个文件；举例来说：假设Block为4KB，而文件只有100B，这个文件仍然要占用1个Block的存储空间。因此，在进行Block大小规划的时候，需要考虑如下两个方面：

* 文件的读写效率；
* 文件大小可能造成的磁盘空间浪费；

###磁盘分区

我是一个保守的人，做事的原则是能不改变就不要改变（墨守成规？嗯，是这样），想问一下，磁盘分区出现之前没有磁盘分区，后来为什么会出现磁盘分区（partition）？

你是什么样的人，我管不着，不过上面是个好问题。

###磁盘格式化



##文件系统


##参考资料

1. 深入理解计算机系统
2. 鸟哥私房菜（基础篇）第三版
3. Disk formatting wiki: [http://en.wikipedia.org/wiki/Disk_formatting](http://en.wikipedia.org/wiki/Disk_formatting)
4. ID：南非蚂蚁的[介绍](http://linux.chinaunix.net/techdoc/beginner/2009/07/15/1124345.shtml)


[NingG]:    http://ningg.github.com  "NingG"
