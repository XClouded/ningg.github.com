<!DOCTYPE html>
<html xmlns:wb="http://open.weibo.com/wb">
<head>
    <!--   Author: NingG   -->
    <meta charset="utf-8" />
	<meta property="wb:webmaster" content="7ea7f3d5f3edad6a" />
    <title>Ganglia监控Flume、Kafka、Storm | ningg.top</title>
    <meta name="author" content="NingG" />
    <meta name="renderer" content="webkit">
    <meta name="description" content=" 存在感对于每个人的生活有多么的重要，可能平时并不是太关注，其实他就是生活的全部  " />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">

    <link rel="stylesheet" href="/css/default.css" type="text/css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="alternate" type="application/atom+xml" title="Recent Entries" href="" />
	
    <script src="/js/jquery-1.7.1.min.js" type="text/javascript"></script>
	<script src="http://tjs.sjs.sinajs.cn/open/api/js/wb.js" type="text/javascript" charset="utf-8"></script>
	<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</head>
<body>
	
    <div class="home-menu">
        <div class="home-icon-con">
            <a class="home-menu-icon" href="/">NingG</a>
            <a class="home-follow" href="#" title="Contact Me">+</a>
        </div>
        <div class="home-contact">
            <a href="http://weibo.com/ggningg/" target="_blank" style="margin-left:-5px;"><img src="http://www.weibo.com/favicon.ico" alt="" width="25"/></a>
            <a href="http://www.douban.com/people/ggningg/" target="_blank" style="text-align:center;"><img src="http://www.douban.com/favicon.ico" alt="" width="22"/></a>
			<a href="http://github.com/ningg" alt="" target="_blank" style="text-align:right;"><img src="/images/icon-cube-smaller.png" width="22"/></a>
        </div>
    </div>

    <link rel="stylesheet" href="/js/prettify/prettify.css" />
<style type="text/css">
    body { background:#e8e8e8; }
    @media screen and (max-width: 750px){
        body { background:#fff; }
    }
    @media screen and (max-width: 1020px){
        body { background:#fff; }
    }
</style>

<div id="content">
    <div class="entry">
        <h1 class="entry-title"><a href="/ganglia-with-flume-kafka-storm" title="Ganglia监控Flume、Kafka、Storm">Ganglia监控Flume、Kafka、Storm</a></h1>
        <p class="entry-date">2014-12-12</p>
        <h2 id="section">背景</h2>

<p>通常利用Flume、Kafka、Storm来搭建实时的日志分析系统，那如何对这一系统运行状态进行监控呢？赶快调研一下，看看业内其他人怎么做的监控，当前能够查到的唯品会工程师<code>Yaobaniu</code>对外分享的实时日志分析平台材料，初步可以推断其使用Zabbix进行的监控，因为<code>baniu</code>在PPTV工作时，主要工作就是专注利用Zabbix进行集群监控，并且在<code>baniu</code>的其他分享资料中，见到过Zabbix监控界面的截图，so，初步推断是Zabbix。不过，本文将采用Ganglia来进行监控，原因很简单：</p>

<ul>
  <li>没有Zabbix的使用经验；</li>
  <li>Flume官网中有利用Ganglia监控Flume运行状态的介绍；</li>
  <li>Kafka、Storm的ecosystem中也见到了与Ganglia结合的身影；</li>
</ul>

<h2 id="section-1">前期准备</h2>

<p>在阅读本文之前，要求对Ganglia的安装配置有一个基本的了解，具体要了解几点：</p>

<ul>
  <li>安装Ganglia集群；</li>
  <li>gmond的配置文件<code>gmond.conf</code>；</li>
  <li>gmetad的配置文件<code>gmetad.conf</code>；</li>
</ul>

<p>上面的内容，可以参考自己之前的几篇博文：</p>

<p>（ganglia的整个系列）</p>

<h2 id="section-2">软件版本</h2>

<table>
  <thead>
    <tr>
      <th>软件</th>
      <th>版本</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Flume</td>
      <td>apache-flume-1.5.0.1-bin.tar.gz</td>
    </tr>
    <tr>
      <td>Kafka</td>
      <td>kafka_2.9.2-0.8.1.1.tgz</td>
    </tr>
    <tr>
      <td>Storm</td>
      <td>apache-storm-0.9.2-incubating.tar.gz</td>
    </tr>
    <tr>
      <td>Ganglia</td>
      <td> </td>
    </tr>
  </tbody>
</table>

<h2 id="ganglia-with-flume">Ganglia with Flume</h2>

<p>Flume的官网上<a href="https://flume.apache.org/FlumeUserGuide.html#monitoring">Monitoring</a>部分，显示通过简单配置，即可完成Ganglia对Flume的监控，关于具体细节，参考阅读<a href="/flume-user-guide-monitoring">Flume user-guide-monitoring</a>。</p>

<p>同时Flume的监控问题，在JIRA上也有较广泛的讨论，为开拓思路，也可以看看<a href="https://issues.apache.org/jira/browse/FLUME">jira Flume</a>。</p>

<h2 id="ganglia-with-kafka">Ganglia with Kafka</h2>

<p>本文将描述一下，围绕“利用Ganglia监控Kafka”这一问题，如何思考、如何分析、如何搜索解决方案。</p>

<h3 id="section-3">分析</h3>

<p>直接列一下，分析、查找途径：</p>

<ul>
  <li>查看Kafka的<a href="http://kafka.apache.org/documentation.html#monitoring">官方文档</a>其中提到了Monitoring，是利用<code>Yammer Metrics</code>来收集数据的，并且列出了一些需要着重关注的指标；</li>
  <li><a href="https://cwiki.apache.org/confluence/display/KAFKA/Ecosystem">Kafka ecosystem</a>中查看到<a href="https://github.com/adambarthelson/kafka-ganglia">Ganglia Integration</a>；</li>
  <li><a href="https://cwiki.apache.org/confluence/display/KAFKA/Index">Ganglia cwiki</a>中查看到<a href="https://cwiki.apache.org/confluence/display/KAFKA/JMX+Reporters">JMX reporters</a>，并在其下查看到<a href="https://github.com/criteo/kafka-ganglia">kafka-ganglia</a>；</li>
  <li>浏览<a href="https://issues.apache.org/jira/browse/KAFKA">jira Kafka</a>，大部分涉及到Kafka Ganglia的内容为bug修复，版本升级；</li>
</ul>

<p>上面是对整个Kafka官网的初步查询结果，从中可以看到，已经有利用Ganglia监控Kafka的监控方案了，具体有两个：</p>

<ul>
  <li><a href="https://github.com/adambarthelson/kafka-ganglia">Ganglia Integration</a>；
    <ul>
      <li>利用JMXTrans来收集Kafka运行状态；</li>
      <li>通过Json来配置，收集指定的Kafka运行状态数据；</li>
      <li>调整gweb页面；</li>
      <li>最后更新时间：2013.06</li>
    </ul>
  </li>
  <li><a href="https://github.com/criteo/kafka-ganglia">kafka-ganglia</a>；
    <ul>
      <li>利用Kafka官网提到的Yammer Metrics收集到的数据；</li>
      <li>利用metrics-ganglia.jar将Yammer Metrics收集的数据发送到Ganglia展示；</li>
      <li>最后更新时间：2014.01</li>
    </ul>
  </li>
</ul>

<h3 id="kafka-gangliacriteo">kafka-ganglia(criteo)</h3>

<p>由于最新工程对当前版本兼容性可能更好，以及与Kafka利用Yammer Metrics机制保持一致，初步决定采用<a href="https://github.com/criteo/kafka-ganglia">kafka-ganglia</a>工程。拿到这一工程后，利用Maven对其进行构建，不过我本地测试需要调整一下<code>artifactId=scalatest_2.9.2</code>的版本：</p>

<pre><code>&lt;dependency&gt;
  &lt;groupId&gt;org.scalatest&lt;/groupId&gt;
  &lt;artifactId&gt;scalatest_2.9.2&lt;/artifactId&gt;
  &lt;version&gt;1.7.2&lt;/version&gt;
  &lt;scope&gt;test&lt;/scope&gt;
&lt;/dependency&gt;
</code></pre>

<p>不过其中涉及到一个情况：ganglia web上显示收集到的Kafka指标过多，近<code>1k+</code>，过于臃肿，需要进行定制和过滤；</p>

<ul>
  <li>筛选出能够反映Kafka集群运行状态的关键指标；</li>
  <li>如果指标为Yammer metrics中的meter类别，针对单个指标分析需要过滤的项，并定制进行过滤，不要显示在ganglia web上；</li>
</ul>

<p>经过自己简单分析，上面两个问题都有解决的办法：</p>

<ul>
  <li>依照官网<a href="http://kafka.apache.org/documentation.html#monitoring">Kafka doc：Monitoring</a>中提到的特别需要关注的参数，进行提炼之后，借助<a href="https://github.com/criteo/kafka-ganglia">kafka-ganglia</a>中的<code>exclude.regex</code>机制来过滤掉不需要的参数，另外，需要特别注意criteo在实现的时候，利用的是<code>matcher.matches()</code>方法，其尝试匹配整个Metric name；<em>（利用matcher.find()方法时，匹配的是是否找到这一参数）</em></li>
  <li>定制<a href="https://github.com/criteo/kafka-ganglia">kafka-ganglia</a>中的<code>exclude.regex</code>机制，如果需要监控的参数很少，则实现<code>include</code>机制，可以利用Regular Exp，也可以使用Set机制；</li>
  <li>对于筛选出的特定参数，如果其是Yammer Metrics中的meter类型，则其中包含了<code>count</code>、<code>mean rate</code>、<code>1-min rate</code>、<code>5-min rate</code>、<code>15-min rate</code>共计5个指标，那这些指标是有些重复的，原因是Ganglia提供了对一个参数的长期监控，例如<code>1-min rate</code>就可以推测出<code>5-min rate</code>等。通过初步分析，认为保留<code>count</code>和<code>1-min rate</code>指标即可。那代码上如何实现？初步分析，认为重写<code>metrics-ganglia-2.2.0.jar</code>中的<code>com.yammer.metrics.reporting</code>包内的<code>GangliaReporter</code>类即可。<em>（此想法只是指出方向，并未进行实际验证）</em></li>
</ul>

<h3 id="ganglia-integrationadambarthelson">Ganglia Integration(adambarthelson)</h3>

<p>（doing…）</p>

<p>从上以部分发现，如果利用<code>metrics-ganglia-2.2.0.jar</code>来实现Ganglia对Kafka的监控，有几个方面需要定制，涉及到一些定制的工作量。而<a href="https://github.com/adambarthelson/kafka-ganglia">Ganglia Integration</a>好像可以直接通过Json文件来指定收集特定的参数，涉及到的定制可能会较少。</p>

<p>（doing…）</p>

<p>初步计划，在配置完Ganglia对Storm的监控时，学习一下jmxtrans的基本知识，然后回过头来，再来尝试一下<a href="https://github.com/adambarthelson/kafka-ganglia">Ganglia Integration</a>。</p>

<h2 id="ganglia-with-storm">Ganglia with Storm</h2>

<p>如何找到Ganglia监控Storm的方法？找到方法后，具体如何进行操作？</p>

<h3 id="section-4">分析</h3>

<p>对于ASF（Apache Software Foundation，Apache软件基金会）下的opensource项目，我个人认为有几个信息源：</p>

<ul>
  <li>open-source项目的官网：<code>http://***.apache.org</code>；</li>
  <li>Apache的Confluence网站：<code>http://cwiki.apache.org/</code>；</li>
  <li>Apache在Jira上进行的问题讨论：<code>https://issues.apache.org/</code>；</li>
  <li>google search；</li>
</ul>

<p>此次查询如何利用Ganglia来监控Storm，还按照这几个信息源来查询：</p>

<ul>
  <li>官网中，只找到如下几个来源，monitoring Storm相关：
    <ul>
      <li><a href="http://storm.apache.org/documentation/Setting-up-a-Storm-cluster.html">setup a storm cluster</a></li>
      <li><a href="http://storm.apache.org/documentation/Running-topologies-on-a-production-cluster.html">running topol on prod cluster</a></li>
    </ul>
  </li>
  <li>google查到相关内容如下：
    <ul>
      <li><a href="https://www.safaribooksonline.com/library/view/learning-storm/9781783981328/">BOOK-Learning Storm</a><em>（通过某种合法方式，拿到了这本书的草稿版）</em></li>
      <li><a href="https://blog.relateiq.com/monitoring-storm/">Monitoring Storm</a></li>
    </ul>
  </li>
</ul>

<p>其中<a href="https://www.safaribooksonline.com/library/view/learning-storm/9781783981328/">BOOK-Learning Storm</a>详细介绍了Ganglia监控Storm的具体操作步骤，其基本原理是利用jmxtrans<em>（从哪收集的运行数据？谁负责发送给Ganglia？）</em></p>

<h3 id="gangliastorm">Ganglia监控Storm</h3>

<blockquote>
  <p>这一部分参考自<a href="https://www.safaribooksonline.com/library/view/learning-storm/9781783981328/">BOOK-Learning Storm</a>，细微的地方做出调整。</p>
</blockquote>

<p>Storm doesn’t have built-in support to monitor the Storm cluster using Ganglia. However, with
jmxtrans, you can enable Storm monitoring using Ganglia. The <code>jmxtrans</code> tool allows you to
connect to any JVM and fetches its JVM metrics without writing a single line of code. The JVM
metrics exposed via JMX can be displayed on Ganglia using jmxtrans. Hence, jmxtrans acts as a
bridge between Storm and Ganglia.</p>

<p><img src="/images/learning-storm/jmxtrans-ganglia.png" alt="" /></p>

<p>需要在Storm运行的节点上安装jmxtrans：</p>

<p>（自己有一篇单独介绍jmxtrans的博客，给个链接）</p>

<h4 id="jvmjmx">开启jvm的jmx功能</h4>

<h4 id="supervisorjson">supervisor.json</h4>

<pre><code>{
  "servers": [
    {
	  "port": "12346", 
	  "host": "IP_OF_SUPERVISOR_MACHINE", 
	  "queries": [
	  	{
	  	  "outputWriters": [
	  	  	{
	  	  	  "@class": "com.googlecode.jmxtrans.model.output.GangliaWriter", 
	  	  	  "settings": {
	  	  	  	"groupName": "supervisor", 
	  	  	  	"host": "IP_OF_GANGLIA_GMOND_SERVER", 
	  	  	  	"port": "8649"
	  	  	  }
	  	  	}
	  	  ], 
	  	  "obj": "java.lang:type=Memory", 
	  	  "resultAlias": "supervisor", 
	  	  "attr": [
	  	  	"ObjectPendingFinalizationCount"
	  	  ]
	  	}, 
	  	{
	  	  "outputWriters": [
	  	  	{
	  	  	  "@class": "com.googlecode.jmxtrans.model.output.GangliaWriter", 
	  	  	  "settings": {
	  	  	  	"groupName": " supervisor ", 
	  	  	  	"host": "IP_OF_GANGLIA_GMOND_SERVER", 
	  	  	  	"port": "8649"
	  	  	  }
	  	  	}
	  	  ], 
	  	  "obj": "java.lang:name=Copy,type=GarbageCollector", 
	  	  "resultAlias": " supervisor ", 
	  	  "attr": [
	  	  	"CollectionCount", 
	  	  	"CollectionTime"
	  	  ]
	  	}, 
	  	{
	  	  "outputWriters": [
	  	  	{
	  	  	  "@class": "com.googlecode.jmxtrans.model.output.GangliaWriter", 
	  	  	  "settings": {
	  	  	  	"groupName": "supervisor ", 
	  	  	  	"host": "IP_OF_GANGLIA_GMOND_SERVER", 
	  	  	  	"port": "8649"
	  	  	  }
	  	  	}
	  	  ], 
	  	  "obj": "java.lang:name=Code Cache,type=MemoryPool", 
	  	  "resultAlias": "supervisor ", 
	  	  "attr": [
	  	  	"CollectionUsageThreshold", 
	  	  	"CollectionUsageThresholdCount", 
	  	  	"UsageThreshold", 
	  	  	"UsageThresholdCount"
	  	  ]
	  	}, 
	  	{
	  	  "outputWriters": [
	  	  	{
	  	  	  "@class": "com.googlecode.jmxtrans.model.output.GangliaWriter", 
	  	  	  "settings": {
	  	  	  	"groupName": "supervisor ", 
	  	  	  	"host": "IP_OF_GANGLIA_GMOND_SERVER", 
	  	  	  	"port": "8649"
	  	  	  }
	  	  	}
	  	  ], 
	  	  "obj": "java.lang:type=Runtime", 
	  	  "resultAlias": "supervisor", 
	  	  "attr": [
	  	  	"StartTime", 
	  	  	"Uptime"
	  	  ]
	  	}
	  ], 
	  "numQueryThreads": 2
    }
  ]
}
</code></pre>

<h2 id="section-5">杂谈</h2>

<p>“见自己，见天地，见众生”，突然想到这句话，说是排rank大多是年轻人的想法，而实际上绝大部分有点成绩的人最后都殊途同归：见众生；做对众生有用、有益的事情。</p>



        <div id="disqus_container">
            <div style="margin-bottom:20px" class="right">
				<wb:share-button appkey="2306590132" addition="simple" type="button" ralateUid="2356527183"></wb:share-button>
            </div>
            <!--<a href="#" class="comment" onclick="return false;">点击查看评论</a>-->
            <div id="disqus_thread"></div>
        </div>
    </div>

	
    <div class="sidenav">
		<iframe width="100%" height="75" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=550&fansRow=2&ptype=1&speed=0&skin=1&isTitle=0&noborder=0&isWeibo=0&isFans=0&uid=2356527183&verifier=1ccfb61e&colors=d6f3f7,ffffff,666666,0082cb,ecfbfd&dpc=1"></iframe>
    </div>

</div>

<script src="/js/post.js" type="text/javascript"></script>


	<div id="gotoTop">Top</div>


    <!--*********************************************************-->
    <!--****** 宝贝儿，看见这个时候，删掉下面的统计代码哦~ ******-->
    <!--*********************************************************-->
	<script>
	  (function(i,s,o,g,r,a,m){
		  i['GoogleAnalyticsObject']=r;i[r]=i[r] || function(){
			(i[r].q=i[r].q||[]).push(arguments)}, i[r].l=1*new Date();
			a=s.createElement(o), m=s.getElementsByTagName(o)[0];
			a.async=1;
			a.src=g;
			m.parentNode.insertBefore(a,m)
	  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	  ga('create', 'UA-48535193-1', 'ningg.github.io');
	  ga('send', 'pageview');
	</script>
    
	
    <script type="text/javascript">
		function gotoTop(min_height){
			$("#gotoTop").click(
				function(){$('html,body').animate({scrollTop:0},700);
			}).hover(
				function(){$(this).addClass("hover");},
				function(){$(this).removeClass("hover");
			});
			min_height ? min_height = min_height : min_height = 600;
			$(window).scroll(function(){
				
				var s = $(window).scrollTop();
				
				if( s > min_height){
					$("#gotoTop").fadeIn(100);
				}else{
					$("#gotoTop").fadeOut(200);
				};
			});
		};
		gotoTop();

        $(function(){
            $('.home-follow').click(function(e){
                e.preventDefault();

                if($('.home-contact').is(':visible')){
                    $('.home-contact').slideUp(100);
                }else{
                    $('.home-contact').slideDown(100);
                }
            });
        })

    </script>
</body>
</html>
