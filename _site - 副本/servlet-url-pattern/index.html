<!DOCTYPE html>
<html xmlns:wb="http://open.weibo.com/wb">
<head>
    <!--   Author: NingG   -->
    <meta charset="utf-8" />
	<meta property="wb:webmaster" content="7ea7f3d5f3edad6a" />
    <title>Servlet下URL映射规则以及冲突匹配原则 | ningg.top</title>
    <meta name="author" content="NingG" />
    <meta name="renderer" content="webkit">
    <meta name="description" content=" 当多个servlet对应的url-pattern都能与url匹配时，哪个Servlet来进行响应？能够多个Servelt响应同一个URL吗？  " />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">

    <link rel="stylesheet" href="/css/default.css" type="text/css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="alternate" type="application/atom+xml" title="Recent Entries" href="" />
	
    <script src="/js/jquery-1.7.1.min.js" type="text/javascript"></script>
	<script src="http://tjs.sjs.sinajs.cn/open/api/js/wb.js" type="text/javascript" charset="utf-8"></script>
	<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</head>
<body>
	
    <div class="home-menu">
        <div class="home-icon-con">
            <a class="home-menu-icon" href="/">NingG</a>
            <a class="home-follow" href="#" title="Contact Me">+</a>
        </div>
        <div class="home-contact">
            <a href="http://weibo.com/ggningg/" target="_blank" style="margin-left:-5px;"><img src="http://www.weibo.com/favicon.ico" alt="" width="25"/></a>
            <a href="http://www.douban.com/people/ggningg/" target="_blank" style="text-align:center;"><img src="http://www.douban.com/favicon.ico" alt="" width="22"/></a>
			<a href="http://github.com/ningg" alt="" target="_blank" style="text-align:right;"><img src="/images/icon-cube-smaller.png" width="22"/></a>
        </div>
    </div>

    <link rel="stylesheet" href="/js/prettify/prettify.css" />
<style type="text/css">
    body { background:#e8e8e8; }
    @media screen and (max-width: 750px){
        body { background:#fff; }
    }
    @media screen and (max-width: 1020px){
        body { background:#fff; }
    }
</style>

<div id="content">
    <div class="entry">
        <h1 class="entry-title"><a href="/servlet-url-pattern" title="Servlet下URL映射规则以及冲突匹配原则">Servlet下URL映射规则以及冲突匹配原则</a></h1>
        <p class="entry-date">2013-05-05</p>
        <h2 id="url-pattern">url-pattern中通配符<code>*</code></h2>

<p>url-pattern中通配符<code>*</code>的使用规则:</p>

<ul>
  <li>同一个Servlet可以被映射到多个URL上，即多个<code>&lt;servlet-mapping&gt;</code>元素的<code>&lt;servlet-name&gt;</code>子元素的设置值可以是同一个Servlet的注册名。  </li>
  <li>在Servlet映射到的URL中也可以使用<code>*</code>通配符，但是只能有两种固定的格式：
    <ul>
      <li>一种格式是<code>*.扩展名</code>；</li>
      <li>另一种格式是以正斜杠（<code>/</code>）开头并以<code>/*</code>结尾。</li>
    </ul>
  </li>
</ul>

<p>示例代码如下：</p>

<pre><code>&lt;servlet-mapping&gt;
	&lt;servlet-name&gt;AnyName&lt;/servlet-name&gt;
	&lt;url-pattern&gt;*.do&lt;/url-pattern&gt;
&lt;/servlet-mapping&gt;

&lt;servlet-mapping&gt;
	&lt;servlet-name&gt;AnyName&lt;/servlet-name&gt;
	&lt;url-pattern&gt;/action/*&lt;/url-pattern&gt;
&lt;/servlet-mapping&gt;
</code></pre>

<h2 id="servleturl">servlet容器对url的匹配过程：</h2>

<p>当一个请求发送到servlet容器的时候，容器先会将请求的url减去当前<code>应用上下文的路径</code>作为servlet的映射url，比如我访问的是 <code>http://localhost/test/aaa.html</code>，我的应用上下文是<code>test</code>，容器会将<code>http://localhost/test</code>去掉，剩下的<code>/aaa.html</code>部分拿来做servlet的映射匹配。这个映射匹配过程是有顺序的，而且<strong>当有一个servlet匹配成功以后，就不会去理会剩下的servlet了</strong>（filter不同，后文会提到）。其匹配规则和顺序如下： </p>

<ul>
  <li><strong>精确路径匹配</strong>。例子：比如servletA 的url-pattern为 /test，servletB的url-pattern为 /* ，这个时候，如果我访问的url为http://localhost/test ，这个时候容器就会先进行精确路径匹配，发现/test正好被servletA精确匹配，那么就去调用servletA，也不会去理会其他的servlet了。</li>
  <li><strong>最长路径匹配</strong>。例子：servletA的url-pattern为/test/<em>，而servletB的url-pattern为/test/a/</em>，此时访问http://localhost/test/a时，容器会选择路径最长的servlet来匹配，也就是这里的servletB。 </li>
  <li><strong>扩展匹配</strong>，如果url最后一段包含扩展，容器将会根据扩展选择合适的servlet。例子：servletA的url-pattern：*.action </li>
  <li><strong>缺省匹配</strong>，如果前面三条规则都没有找到一个servlet，容器会根据url选择对应的请求资源。如果应用定义了一个default servlet，则容器会将请求丢给default servlet（什么是default servlet？请见:web.xml文件中缺省映射路径”/”问题以及客户端访问web资源的匹配规则）。 </li>
</ul>

<p>根据这个规则表，就能很清楚的知道servlet的匹配过程，所以定义servlet的时候也要考虑url-pattern的写法，以免出错。 </p>

<p>对于filter，不会像servlet那样只匹配一个servlet，因为<strong>filter的集合是一个链，所以只会有处理的顺序不同，而不会出现只选择一个filter</strong>。Filter的处理顺序和filter-mapping在web.xml中定义的顺序相同。 </p>

<h2 id="section">缺省匹配</h2>

<p>web.xml中如果某个Servlet的映射路径仅仅为一个正斜杠（<code>/</code>），那么这个Servlet就成为当前Web应用程序的<strong>缺省Servlet</strong>。</p>

<p>凡是在web.xml文件中找不到匹配的<code>&lt;servlet-mapping&gt;</code>元素的URL，它们的访问请求都将交给缺省Servlet处理，也就是说，<strong>缺省Servlet用于处理所有其他Servlet都不处理的访问请求</strong>。</p>

<p>在<code>$TOMCAT_HOMT\conf\web.xml</code>文件中，注册了一个名称为<code>org.apache.catalina.servlets.DefaultServlet</code>的Servlet，并将这个Servlet设置为了<strong>缺省Servlet</strong>。(<code>\conf\web.xml</code>文件所有发布到tomcat的web应用所共享的)</p>

<pre><code> &lt;servlet&gt;
    &lt;servlet-name&gt;default&lt;/servlet-name&gt;
    &lt;servlet-class&gt;org.apache.catalina.servlets.DefaultServlet&lt;/servlet-class&gt;
    &lt;init-param&gt;
       &lt;param-name&gt;debug&lt;/param-name&gt;
       &lt;param-value&gt;0&lt;/param-value&gt;
    &lt;/init-param&gt;
    &lt;init-param&gt;
       &lt;param-name&gt;listings&lt;/param-name&gt;
       &lt;param-value&gt;false&lt;/param-value&gt;
    &lt;/init-param&gt;
    &lt;load-on-startup&gt;1&lt;/load-on-startup&gt;
&lt;/servlet&gt;

&lt;servlet-mapping&gt;
   &lt;servlet-name&gt;default&lt;/servlet-name&gt;
   &lt;url-pattern&gt;/&lt;/url-pattern&gt;
&lt;/servlet-mapping&gt;
</code></pre>

<p>当访问<strong>Tomcat服务器</strong>中的某个<strong>静态HTML文件和图片</strong>时，实际上是在访问这个缺省Servlet，由<strong>Default Servlet类寻找</strong>，当寻找到了请求的html或图片时，则返回其资源文件，如果没有寻找到则报出404错误。</p>

<p>如果在<strong>web应用的web.xml</strong>文件中的<code>&lt;servlet-mapping&gt;</code>中配置了<code>/</code>，如：</p>

<pre><code>&lt;servlet&gt;
  &lt;servlet-name&gt;ServletDemo3&lt;/servlet-name&gt;
  &lt;servlet-class&gt;edu.servlet.ServletDemo3&lt;/servlet-class&gt;
&lt;/servlet&gt;
&lt;servlet-mapping&gt;
  &lt;servlet-name&gt;ServletDemo3&lt;/servlet-name&gt;
  &lt;url-pattern&gt;/&lt;/url-pattern&gt;
&lt;/servlet-mapping&gt;
</code></pre>

<p>则当请求的url和上面其他的<code>&lt;servlet-mapping&gt;</code>均不匹配时，则会交给<code>ServletDemo3.java</code>处理,而不在交给<code>DefaultServlet.java</code>处理，也就是说，当请求web应用中的静态文本或图片或avi视屏等时，则全部进入了ServletDemo3.java,而不会正常返回页面资源。即，web应用的web.xml配置覆盖Tomcat自带的web.xml文件配置。</p>

<h2 id="url-pattern-1">url-pattern详解</h2>

<p>在web.xml文件中，以下语法用于定义映射： </p>

<ul>
  <li>以<code>/</code>开头和以<code>/*</code>结尾的是用来做<strong>路径映射</strong>的。</li>
  <li>以前缀<code>*.</code>开头的是用来做<strong>扩展映射</strong>的。 </li>
  <li><code>/</code> 是用来定义<strong>default servlet映射</strong>的。 </li>
  <li>剩下的都是用来定义<strong>详细映射</strong>的。比如：<code>/aa/bb/cc.action</code></li>
</ul>

<p>所以，为什么定义<code>/*.action</code>这样一个看起来很正常的匹配在启动tomcat时会报错？因为这个匹配既属于<strong>路径映射</strong>，也属于<strong>扩展映射</strong>，导致容器无法判断。</p>

<h2 id="do">示例(*.do的优先级别最低)</h2>

<p>对于如下的一些映射关系：</p>

<ul>
  <li>Servlet1 映射到 <code>/abc/*</code> </li>
  <li>Servlet2 映射到 <code>/*</code></li>
  <li>Servlet3 映射到 <code>/abc</code> </li>
  <li>Servlet4 映射到 <code>*.do</code></li>
</ul>

<p>问题：
* 当请求URL为<code>/abc/a.html</code>，<code>/abc/*</code>和<code>/*</code>都匹配，哪个servlet响应?
	* Servlet引擎将调用Servlet1。
* 当请求URL为<code>/abc</code>时，<code>/abc/*</code>和<code>/abc</code>都匹配，哪个servlet响应?
	* Servlet引擎将调用Servlet3。
* 当请求URL为<code>/abc/a.do</code>时，<code>/abc/*</code>和<code>*.do</code>都匹配，哪个servlet响应?
	* Servlet引擎将调用Servlet1。
* 当请求URL为<code>/a.do</code>时，<code>/*</code>和<code>*.do</code>都匹配，哪个servlet响应?
	* Servlet引擎将调用Servlet2。
* 当请求URL为<code>/xxx/yyy/a.do</code>时，<code>/*</code>和<code>*.do</code>都匹配，哪个servlet响应?
	* Servlet引擎将调用Servlet2。</p>

<h2 id="section-1">参考来源</h2>

<ul>
  <li><a href="http://blog.csdn.net/xh16319/article/details/8014107">Servlet映射规则和Servlet的映射URL冲突时匹配原则</a></li>
</ul>



        <div id="disqus_container">
            <div style="margin-bottom:20px" class="right">
				<wb:share-button appkey="2306590132" addition="simple" type="button" ralateUid="2356527183"></wb:share-button>
            </div>
            <!--<a href="#" class="comment" onclick="return false;">点击查看评论</a>-->
            <div id="disqus_thread"></div>
        </div>
    </div>

	
    <div class="sidenav">
		<iframe width="100%" height="75" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=550&fansRow=2&ptype=1&speed=0&skin=1&isTitle=0&noborder=0&isWeibo=0&isFans=0&uid=2356527183&verifier=1ccfb61e&colors=d6f3f7,ffffff,666666,0082cb,ecfbfd&dpc=1"></iframe>
    </div>

</div>

<script src="/js/post.js" type="text/javascript"></script>


	<div id="gotoTop">Top</div>


    <!--*********************************************************-->
    <!--****** 宝贝儿，看见这个时候，删掉下面的统计代码哦~ ******-->
    <!--*********************************************************-->
	<script>
	  (function(i,s,o,g,r,a,m){
		  i['GoogleAnalyticsObject']=r;i[r]=i[r] || function(){
			(i[r].q=i[r].q||[]).push(arguments)}, i[r].l=1*new Date();
			a=s.createElement(o), m=s.getElementsByTagName(o)[0];
			a.async=1;
			a.src=g;
			m.parentNode.insertBefore(a,m)
	  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	  ga('create', 'UA-48535193-1', 'ningg.github.io');
	  ga('send', 'pageview');
	</script>
    
	
    <script type="text/javascript">
		function gotoTop(min_height){
			$("#gotoTop").click(
				function(){$('html,body').animate({scrollTop:0},700);
			}).hover(
				function(){$(this).addClass("hover");},
				function(){$(this).removeClass("hover");
			});
			min_height ? min_height = min_height : min_height = 600;
			$(window).scroll(function(){
				
				var s = $(window).scrollTop();
				
				if( s > min_height){
					$("#gotoTop").fadeIn(100);
				}else{
					$("#gotoTop").fadeOut(200);
				};
			});
		};
		gotoTop();

        $(function(){
            $('.home-follow').click(function(e){
                e.preventDefault();

                if($('.home-contact').is(':visible')){
                    $('.home-contact').slideUp(100);
                }else{
                    $('.home-contact').slideDown(100);
                }
            });
        })

    </script>
</body>
</html>
