<!DOCTYPE html>
<html xmlns:wb="http://open.weibo.com/wb">
<head>
    <!--   Author: NingG   -->
    <meta charset="utf-8" />
	<meta property="wb:webmaster" content="7ea7f3d5f3edad6a" />
    <title>编译flume：使用eclipse查看flume源码 | ningg.top</title>
    <meta name="author" content="NingG" />
    <meta name="renderer" content="webkit">
    <meta name="description" content=" flume是开源的分布式日志采集系统，深入使用flume，编译查看flume源码是正道  " />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">

    <link rel="stylesheet" href="/css/default.css" type="text/css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="alternate" type="application/atom+xml" title="Recent Entries" href="" />
	
    <script src="/js/jquery-1.7.1.min.js" type="text/javascript"></script>
	<script src="http://tjs.sjs.sinajs.cn/open/api/js/wb.js" type="text/javascript" charset="utf-8"></script>
	<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</head>
<body>
	
    <div class="home-menu">
        <div class="home-icon-con">
            <a class="home-menu-icon" href="/">NingG</a>
            <a class="home-follow" href="#" title="Contact Me">+</a>
        </div>
        <div class="home-contact">
            <a href="http://weibo.com/ggningg/" target="_blank" style="margin-left:-5px;"><img src="http://www.weibo.com/favicon.ico" alt="" width="25"/></a>
            <a href="http://www.douban.com/people/ggningg/" target="_blank" style="text-align:center;"><img src="http://www.douban.com/favicon.ico" alt="" width="22"/></a>
			<a href="http://github.com/ningg" alt="" target="_blank" style="text-align:right;"><img src="/images/icon-cube-smaller.png" width="22"/></a>
        </div>
    </div>

    <link rel="stylesheet" href="/js/prettify/prettify.css" />
<style type="text/css">
    body { background:#e8e8e8; }
    @media screen and (max-width: 750px){
        body { background:#fff; }
    }
    @media screen and (max-width: 1020px){
        body { background:#fff; }
    }
</style>

<div id="content">
    <div class="entry">
        <h1 class="entry-title"><a href="/build-flume" title="编译flume：使用eclipse查看flume源码">编译flume：使用eclipse查看flume源码</a></h1>
        <p class="entry-date">2014-09-19</p>
        <h2 id="section">背景</h2>

<p>最近要弄日志收集系统，初始方案是将日志压缩之后，通过类似FTP方式上传，其中有一个问题：日志不能实时收集，因此，无法实时监控系统状态。Flume支持实时的日志采集，妥了，尝试用一下。</p>

<p>说点题外话，通过类似FTP方式上传文件时，还有几个问题，自己仍在思考：</p>

<ul>
  <li>日志上传时，如何确定日志上传完成？</li>
  <li>如果上传过程中出现意外，接收端是否会丢弃已经接收到的文件片段？</li>
  <li>传输的文件是否压缩？</li>
  <li>传输文件直接上传到HDFS上，还是先上传到local FS上？</li>
  <li>日志传输到服务器上之后，如何才能立即就进行分析？</li>
  <li>分析日志之前，怎么判断日志是否满足规范？（命名、编码等）</li>
</ul>

<h2 id="section-1">编译环境</h2>

<p>查看自己机器的环境：我用笔记本来编译的，是win 7（x64）操作系统；更详细的编译环境信息通过如下方式查看：<code>CMD</code>–&gt;<code>systeminfo</code>，这个命令收集系统信息，需要花费40s，稍等一会儿，得到如下信息：</p>

<pre><code>C:\Users\Administrator&gt;systeminfo

OS 名称:          Microsoft Windows 7 旗舰版
OS 版本:          6.1.7601 Service Pack 1 Build 7601

系统类型:         x64-based PC
处理器:           安装了 1 个处理器。
	 [01]: Intel64 Family 6 Model 23 Stepping 6 GenuineIntel ~785 Mhz

物理内存总量:     2,968 MB
可用的物理内存:   819 MB
虚拟内存: 最大值: 5,934 MB
虚拟内存: 可用:   2,196 MB
虚拟内存: 使用中: 3,738 MB
</code></pre>

<h2 id="eclipseflume">Eclipse下查看Flume的源码（推荐）</h2>

<p>下载完Flume的源码包之后，直接将整个flume源码目录，当作<code>Existing  Maven Projects</code>，<code>Import</code>到Eclipse中即可。注，遇到的几个问题：</p>

<ul>
  <li>maven子模块<code>flume-dataset-sink</code>有错误，暂时未解决，close 此模块即可；</li>
  <li><code>flume-ng-core</code>模块的pom.xml文档，提示出错：Plugin execution not covered by lifecycle configuration: org.codehaus.mojo:build-helper-maven-plugin:1.7:add-source (execution: add-source, phase: generate-sources)，暂时不管这一错误，整个工程也能正常运行；</li>
</ul>

<p>下面附一张，将Flume source 以 Maven工程导入Eclipse的效果：</p>

<p><img src="/images/build-flume/flume-maven-src.png" alt="" /></p>

<h3 id="flumedebug">Flume源码的Debug</h3>

<p>本质上Flume是启动一个JVM实例，具体启动参数，可以参考<code>/bin/flume-ng</code>脚本的最终启动命令。列几个启动脚本的常量，就是JVM实例的main class：</p>

<pre><code>FLUME_AGENT_CLASS="org.apache.flume.node.Application"
FLUME_AVRO_CLIENT_CLASS="org.apache.flume.client.avro.AvroCLIClient"
FLUME_VERSION_CLASS="org.apache.flume.tools.VersionInfo"
FLUME_TOOLS_CLASS="org.apache.flume.tools.FlumeToolsMain"
</code></pre>

<p>TODO：</p>

<ul>
  <li>在本地开发Flume的组件；</li>
  <li>本地启动Eclipse下的Flume工程（从入口类），</li>
</ul>

<h2 id="span-stylecolorredspan">开始编译（<span style="color:red">废弃</span>）</h2>

<p><strong>备注</strong>：不必再通过mvn命令，将原始的flume源码编译为Eclipse工程了，直接将原始的flume源码作为maven工程导入即可，具体，参考前一部分<strong>Eclipse下查看Flume的源码（推荐）</strong>。</p>

<p>OK，在这台Win7上，编译flume源码，走起。</p>

<blockquote>
  <p>特别说明：这些内容，都是我从官网看来的，建议有点追求的coder，多看看<a href="http://flume.apache.org/">flume官网</a>，这样才能有提高，我的博客仅仅是自己留作备份看的。</p>
</blockquote>

<h3 id="section-2">下载源码</h3>

<p>Apache flume的下载页面：<a href="http://flume.apache.org/download.html">Apache Flume Download</a>。</p>

<p>我下载的是当前稳定版本flume对应的源码：<a href="http://www.apache.org/dyn/closer.cgi/flume/1.5.0.1/apache-flume-1.5.0.1-src.tar.gz">apache-flume-1.5.0.1-src</a></p>

<h3 id="section-3">开始编译</h3>

<p>根据官方资料：<a href="https://cwiki.apache.org/confluence/display/FLUME/Development+Environment">flume开发&amp;调试环境</a>，开始编译。此次编译，我的目标很简单：在eclipse下查看flume的源代码。具体编译时，使用的命令：</p>

<pre><code>mvn install -DskipTests
mvn eclipse:eclipse -DdownloadSources
</code></pre>

<h3 id="section-4">出现的问题</h3>

<p>执行命令<code>mvn install -DskipTests</code>后，程序有一段时间静止在编译flume ng core的模块上，强行终止（操作：<code>ctrl + c</code>）后，使用  “mvn install -rf :flume-ng-core -X “ 启动debug进行问题定位找到线索:</p>

<p>分析之后，修改flume-ng-core\scripts\目录下<code>saveVersion.ps1</code>，将其中powershell的两个参数<code>args[0]</code>和<code>args[1]</code>替换为实际值即可。在此之前，需要确认windows系统已经安装了powershell，验证是否安装powershell的方法：<code>运行</code>–&gt;<code>powershell</code>，看看是否能够进入与<code>cmd</code>类似的命令页面（我的win7系统默认带了powershell）。
如果没有安装powershell，请参考：<a href="http://support.microsoft.com/kb/968929">windows管理框架</a>。</p>

<p>在编译<code>flume-ng-morphline-solr-sink</code>过程中，由于GFW等等原因，可能无法访问<code> repository.cloudera.com</code>，导致编译失败，失败信息详情如下：</p>

<pre><code>[ERROR] Failed to execute goal on project flume-ng-morphline-solr
-sink: Could not resolve dependencies for project org.apache.flum
e.flume-ng-sinks:flume-ng-morphline-solr-sink:jar:1.5.0.1: Failed
 to collect dependencies at org.kitesdk:kite-morphlines-all:pom:0
.12.0: Failed to read artifact descriptor for org.kitesdk:kite-mo
rphlines-all:pom:0.12.0: Could not transfer artifact org.kitesdk:
kite-morphlines-all:pom:0.12.0 from/to cdh.repo (https://reposito
ry.cloudera.com/artifactory/cloudera-repos): repository.cloudera.
com: Unknown host repository.cloudera.com -&gt; [Help 1]
</code></pre>

<p>浏览一下，失败信息的大意是：编译<code>flume-ng-morphline-solr-sink</code>过程中，寻找依赖(dependency)失败，这是由于远端cloudera仓库对应的域名<code>repository.cloudera.com</code>无法解析引发的。OK，既然找不到这个cloudera仓库，那直接取消对这一仓库的引用好了，具体：修改flume-ng-sinks\flume-ng-morphline-solr-sink\目录下<code>pom.xml</code>文件，将<code>&lt;repository&gt;</code>元素注释掉，最终效果如表：</p>

<repositories>

	<!--
	<repository>
	  <id>cdh.repo</id>
	  <url>https://repository.cloudera.com/artifactory/cloudera-repos</url>
	  <name>Cloudera Repositories</name>
	  <snapshots>
		<enabled>false</enabled>
	  </snapshots>
	</repository>

	<repository>
	  <id>cdh.snapshots.repo</id>
	  <url>https://repository.cloudera.com/artifactory/libs-snapshot-local</url>
	  <name>Cloudera Snapshots Repository</name>
	  <snapshots>
		<enabled>true</enabled>
	  </snapshots>
	  <releases>
		<enabled>false</enabled>
	  </releases>
	</repository>
	-->

  </repositories>

<p>ok，重新执行命令<code>mvn install -DskipTests</code>，欧NO，又出错了，得到如下信息：</p>

<pre><code>[ERROR] Failed to execute goal on project flume-ng-morphline-solr
-sink: Could not resolve dependencies for project org.apache.flum
e.flume-ng-sinks:flume-ng-morphline-solr-sink:jar:1.5.0.1: The fo
-llowing artifacts could not be resolved: org.kitesdk:kite-morphli
nes-all:pom:0.12.0, org.kitesdk:kite-morphlines-solr-core:jar:tes
-ts:0.12.0: Failure to find org.kitesdk:kite-morphlines-all:pom:0.
12.0 in http://repo1.maven.org/maven2 was cached in the local repo
-sitory, resolution will not be reattempted until the update inte
rval of repo1.maven.org has elapsed or updates are forced -&gt; [Help 1]
</code></pre>

<p>平复一下心情，看看上面的提示，大意是说找不到<code>kite-morphlines-all</code>，看来之前粗鲁的将<code>&lt;repository&gt;</code>元素注释掉，并不能解决问题，OK，再找两个替代的repository就好了，具体再次修改flume-ng-sinks\flume-ng-morphline-solr-sink\目录下<code>pom.xml</code>文件如下：</p>

<pre><code>  &lt;repositories&gt;
	&lt;repository&gt;
		&lt;id&gt;maven-restlet&lt;/id&gt;
		&lt;name&gt;Public online Restlet repository&lt;/name&gt;
		&lt;url&gt;http://maven.restlet.org&lt;/url&gt;
	&lt;/repository&gt;
  &lt;/repositories&gt;
</code></pre>

<p>并且修改flume源代码根目录下的<code>pom.xml</code>文件，将其中<code>&lt;kite.version&gt;0.12.0&lt;/kite.version&gt;</code>，修改为<code>&lt;kite.version&gt;0.15.0&lt;/kite.version&gt;</code>。</p>

<p>又有依赖(dependency)找不到了：</p>

<pre><code>[ERROR] Failed to execute goal on project flume-ng-morphline-solr
-sink: Could not resolve dependencies for project org.apache.flum
e.flume-ng-sinks:flume-ng-morphline-solr-sink:jar:1.5.0.1: Failed
 to collect dependencies at org.kitesdk:kite-morphlines-all:pom:0
.12.0 -&gt; org.kitesdk:kite-morphlines-useragent:jar:0.12.0 -&gt; ua_p
arser:ua-parser:jar:1.3.0: Failed to read artifact descriptor for
 ua_parser:ua-parser:jar:1.3.0: Could not transfer artifact ua_pa
rser:ua-parser:pom:1.3.0 from/to maven-twttr (http://maven.twttr.
com): Connection to http://maven.twttr.com refused: Connection ti
med out: connect -&gt; [Help 1]
</code></pre>

<p>再次修改flume-ng-sinks\flume-ng-morphline-solr-sink\目录下<code>pom.xml</code>文件，在<code>&lt;repositories&gt;</code>下添加一个元素：</p>

<pre><code>&lt;repositories&gt;
	
	... 
	
	&lt;repository&gt;
	  &lt;id&gt;p2.jfrog.org&lt;/id&gt;
	  &lt;url&gt;http://p2.jfrog.org/libs-releases&lt;/url&gt;
	&lt;/repository&gt;
&lt;/repositories&gt;
</code></pre>

<p>重新编译，还不行，说是找不到<code>p2.jfrog.org</code>，怒了，翻墙，再编译，搞定。（有的网络环境，不需要翻墙，也能编译通过）</p>

<h3 id="eclipse">eclipse下查看源码</h3>

<p>上面编译之后，在eclipse下，<code>Import</code>–&gt;<code>Existing Projects into Workspace</code>，然后选择flume编译源码的路径即可，结果如下图所示：</p>

<p><img src="/images/build-flume/eclipse-flume-src.jpg" alt="eclipse-src" /></p>

<p><strong>疑问</strong>：</p>

<ul>
  <li>使用maven管理的代码，为什么不作为maven项目Import到eclipse下？而是先运行命令<code>mvn eclipse:eclipse</code>，然后将项目作为普通的java project导入到eclipse？<strong>RE</strong>：两种方式是等价的，只不过利用<code>mvn eclipse:eclipse</code>命令，下载jar，感觉稍微快一点，可以先通过mvn命令进行编译，然后，重新打开一个新的src文件夹，并将其作为maven项目import到eclipse下<em>（需要调整一些，build path）</em>；</li>
  <li>使用eclipse来查看、调试flume源码，那如何对外发布源码？</li>
  <li>总结一下，就是一个问题<code>mvn eclipse:eclipse</code>过程中到底执行了什么？为什么要这么做？避免了，eclipse下安装m2eclipse插件，不过一般eclipse都默认安装了m2eclipse插件。</li>
</ul>

<blockquote>
  <p><strong>后记</strong>：每次编译代码，网络都让人蛋疼，GFW让人蛋疼，有一个VPN太重要了。</p>
</blockquote>

<h2 id="section-5">参考来源</h2>

<ul>
  <li><a href="http://flume.apache.org/">flume官网</a></li>
  <li><a href="https://cwiki.apache.org/confluence/display/FLUME/Development+Environment">flume开发&amp;调试环境</a></li>
</ul>



        <div id="disqus_container">
            <div style="margin-bottom:20px" class="right">
				<wb:share-button appkey="2306590132" addition="simple" type="button" ralateUid="2356527183"></wb:share-button>
            </div>
            <!--<a href="#" class="comment" onclick="return false;">点击查看评论</a>-->
            <div id="disqus_thread"></div>
        </div>
    </div>

	
    <div class="sidenav">
		<iframe width="100%" height="75" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=550&fansRow=2&ptype=1&speed=0&skin=1&isTitle=0&noborder=0&isWeibo=0&isFans=0&uid=2356527183&verifier=1ccfb61e&colors=d6f3f7,ffffff,666666,0082cb,ecfbfd&dpc=1"></iframe>
    </div>

</div>

<script src="/js/post.js" type="text/javascript"></script>


	<div id="gotoTop">Top</div>


    <!--*********************************************************-->
    <!--****** 宝贝儿，看见这个时候，删掉下面的统计代码哦~ ******-->
    <!--*********************************************************-->
	<script>
	  (function(i,s,o,g,r,a,m){
		  i['GoogleAnalyticsObject']=r;i[r]=i[r] || function(){
			(i[r].q=i[r].q||[]).push(arguments)}, i[r].l=1*new Date();
			a=s.createElement(o), m=s.getElementsByTagName(o)[0];
			a.async=1;
			a.src=g;
			m.parentNode.insertBefore(a,m)
	  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	  ga('create', 'UA-48535193-1', 'ningg.github.io');
	  ga('send', 'pageview');
	</script>
    
	
    <script type="text/javascript">
		function gotoTop(min_height){
			$("#gotoTop").click(
				function(){$('html,body').animate({scrollTop:0},700);
			}).hover(
				function(){$(this).addClass("hover");},
				function(){$(this).removeClass("hover");
			});
			min_height ? min_height = min_height : min_height = 600;
			$(window).scroll(function(){
				
				var s = $(window).scrollTop();
				
				if( s > min_height){
					$("#gotoTop").fadeIn(100);
				}else{
					$("#gotoTop").fadeOut(200);
				};
			});
		};
		gotoTop();

        $(function(){
            $('.home-follow').click(function(e){
                e.preventDefault();

                if($('.home-contact').is(':visible')){
                    $('.home-contact').slideUp(100);
                }else{
                    $('.home-contact').slideDown(100);
                }
            });
        })

    </script>
</body>
</html>
