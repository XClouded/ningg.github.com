<!DOCTYPE html>
<html xmlns:wb="http://open.weibo.com/wb">
<head>
    <!--   Author: NingG   -->
    <meta charset="utf-8" />
	<meta property="wb:webmaster" content="7ea7f3d5f3edad6a" />
    <title>不同OS环境下部署Flume Agent | ningg.top</title>
    <meta name="author" content="NingG" />
    <meta name="renderer" content="webkit">
    <meta name="description" content=" Flume用于收集信息，因此，不可避免的，需要部署在不同的环境  " />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">

    <link rel="stylesheet" href="/css/default.css" type="text/css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="alternate" type="application/atom+xml" title="Recent Entries" href="" />
	
    <script src="/js/jquery-1.7.1.min.js" type="text/javascript"></script>
	<script src="http://tjs.sjs.sinajs.cn/open/api/js/wb.js" type="text/javascript" charset="utf-8"></script>
	<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</head>
<body>
	
    <div class="home-menu">
        <div class="home-icon-con">
            <a class="home-menu-icon" href="/">NingG</a>
            <a class="home-follow" href="#" title="Contact Me">+</a>
        </div>
        <div class="home-contact">
            <a href="http://weibo.com/ggningg/" target="_blank" style="margin-left:-5px;"><img src="http://www.weibo.com/favicon.ico" alt="" width="25"/></a>
            <a href="http://www.douban.com/people/ggningg/" target="_blank" style="text-align:center;"><img src="http://www.douban.com/favicon.ico" alt="" width="22"/></a>
			<a href="http://github.com/ningg" alt="" target="_blank" style="text-align:right;"><img src="/images/icon-cube-smaller.png" width="22"/></a>
        </div>
    </div>

    <link rel="stylesheet" href="/js/prettify/prettify.css" />
<style type="text/css">
    body { background:#e8e8e8; }
    @media screen and (max-width: 750px){
        body { background:#fff; }
    }
    @media screen and (max-width: 1020px){
        body { background:#fff; }
    }
</style>

<div id="content">
    <div class="entry">
        <h1 class="entry-title"><a href="/deploy-flume-agent" title="不同OS环境下部署Flume Agent">不同OS环境下部署Flume Agent</a></h1>
        <p class="entry-date">2015-01-21</p>
        <h2 id="section">分析</h2>

<p>开篇扯一扯，Flume Agent要部署到不同的OS环境下，典型的代表：Win XP、Win Server 2008、Linux、Unix。Flume运行在JVM之上，正常情况下，只要安装JRE即可运行Flume Agent。查看<a href="http://flume.apache.org/FlumeUserGuide.html">Flume官方文档</a>，安装Flume Agent时，系统要满足如下几个要求：</p>

<ul>
  <li><strong>Java Runtime Environment</strong> - Java 1.6 or later (Java 1.7 Recommended)</li>
  <li><strong>Memory</strong> - Sufficient memory for configurations used by sources, channels or sinks</li>
  <li><strong>Disk Space</strong> - Sufficient disk space for configurations used by channels or sinks</li>
  <li><strong>Directory Permissions</strong> - Read/Write permissions for directories used by agent</li>
</ul>

<p>整体上，在windows下安装Flume-ng的解决方案，有几个信息源：</p>

<ul>
  <li>Flume官网：官网、讨论区；</li>
  <li>Hadoop商业版企业Hortonworks、Cloudera等；</li>
  <li>通过Search Engine查找；</li>
</ul>

<h2 id="windows-xp">Windows XP</h2>

<p>在Win XP下安装部署一个Flume Agent，同时利用Tail命令实时收集某一文件上追加的内容，简单说，分下面几步：</p>

<ul>
  <li>下载Flume Agent；</li>
  <li>下载Windows XP下的Tail命令；</li>
  <li>定制Flume Agent的bat启动脚本；</li>
</ul>

<h3 id="flume-agent">下载Flume Agent</h3>

<p>下载地址：<a href="http://flume.apache.org/download.html">Flume官方下载地址</a></p>

<h3 id="window-xptail">下载Window XP下的Tail命令</h3>

<p>在StackOverflow上简要查了一下，UnxUtils，GNU utilities for Win32，可在Win32下实现tail命令，具体下载地址：<a href="http://sourceforge.net/projects/unxutils/">UnxUtils官网</a>。</p>

<h3 id="windown-xpbat">定制Windown XP下的bat启动脚本</h3>

<p>在Linux下启动Flume，使用的是<code>bin/flume-ng</code>脚本，这个脚本需要<code>bash shell</code>环境的支持，而Windows下没有<code>bash shell</code>，这样是不是就没有办法在Windows下启动Flume了？仔细想一下，两点：</p>

<ul>
  <li>Flume是运行在JVM上的，有JRE就可以启动了；</li>
  <li><code>bin/flume-ng</code>启动脚本，本质就是启动JVM实例；</li>
  <li>Windows下编写一个简单的bat脚本，就可以实现<code>bin/flume-ng</code>类似的功能；</li>
</ul>

<p>上面基本思路理清楚了，去官网查一下，看看有没有人在Windows XP下进行Flume Agent的部署，借鉴一下。找到如下几个参考来源：</p>

<ul>
  <li><a href="http://abloz.com/flume/windows_download.html">Flume windows version</a></li>
  <li><a href="http://abloz.com/2013/02/18/compile-under-windows-flume-1-3-1.html">windows下编译flume</a></li>
  <li><a href="https://cwiki.apache.org/confluence/display/FLUME/Build+Flume+1.3.x+up+on+Windows">Build Flume 1.3.x on Windows</a></li>
</ul>

<p>具体编写之后的<code>bin/flume-win.bat</code>启动脚本如下：</p>

<pre><code>::@echo off

::USAGE: 	apache-flume-1.5.0.1-bin&gt;call bin/flume-win*.bat
::AUTHOER:	Ning Guo of CIB
::TIME:		2014/11/28  12:55

::set java home
set JAVA_HOME="D:\Program Files\Java\jdk1.7.0_67"

::set configuration file
set CONF_FILE=logToKafka.properties

::set agent name 
set AGENT_NAME=agent


::retrieve the parent directory
setlocal
for %%i in ("%~dp0..") do set "folder=%%~fi"
set FLUME_HOME="%folder%"


%JAVA_HOME%\bin\java.exe -Xms128m -Xmx512m -Dflume.monitoring.type=ganglia -Dflume.monitoring.hosts=168.7.2.165:8649 -Dlog4j.configuration=file:///%FLUME_HOME%\conf\log4j.properties -cp %FLUME_HOME%\lib\* org.apache.flume.node.Application -f %FLUME_HOME%\conf\%CONF_FILE% -n %AGENT_NAME%

pause
</code></pre>

<p>上述涉及flume的配置文件<code>logToKafka.properties</code>，其内容如下：</p>

<pre><code>############################################################## COMPONENTS
# The configuration file needs to define the sources, 
# the channels and the sinks.
# Sources, channels and sinks are defined per agent, 
# in this case called 'agent'

agent.sources = seqGenSrc
agent.channels = memoryChannel
agent.sinks = loggerSink


############################################################## SOURCES
# For each one of the sources, the type is defined


# Exec Source For Flume agent on Win XP(UnxUtils).
agent.sources.seqGenSrc.type = exec
agent.sources.seqGenSrc.command = E:\reference\svn-new-doc\flume\UnxUtils\usr\local\wbin\tail.exe --follow=name --retry E:/1.log
agent.sources.seqGenSrc.restart = true
agent.sources.seqGenSrc.restartThrottle = 1000
agent.sources.seqGenSrc.batchSize = 100
#agent.sources.seqGenSrc.charset = GBK


# Exec Source For Flume agent on Win Server 2008.
#agent.sources.seqGenSrc.type = exec
#agent.sources.seqGenSrc.command = get-content d:/flume/1.log -wait
#agent.sources.seqGenSrc.shell = powershell
#agent.sources.seqGenSrc.restart = true
#agent.sources.seqGenSrc.restartThrottle = 1000
#agent.sources.seqGenSrc.batchSize = 100
#agent.sources.seqGenSrc.charset = GBK


############################################################## SINKS

agent.sinks.loggerSink.type = com.thilinamb.flume.sink.KafkaSink 
#agent.sinks.loggerSink.topic = goodjob
agent.sinks.loggerSink.topic = good
#agent.sinks.loggerSink.charset = GBK
agent.sinks.loggerSink.kafka.metadata.broker.list = 168.7.1.67:9091,168.7.1.68:9091,168.7.1.69:9091,168.7.1.70:9091
agent.sinks.loggerSink.kafka.serializer.class = kafka.serializer.StringEncoder
agent.sinks.loggerSink.kafka.request.required.acks = 1


############################################################## CHANNELS
# Each channel's type is defined.
agent.channels.memoryChannel.type = memory
agent.channels.memoryChannel.capacity = 100000


############################################################## RELATIONS
# The channel can be defined as follows.
agent.sources.seqGenSrc.channels = memoryChannel

#Specify the channel the sink should use
agent.sinks.loggerSink.channel = memoryChannel
</code></pre>

<p><strong>补充说明</strong>：此次启动的Flume Agent通过本地tail命令收集日志内容，并通过KafkaSink将信息送入Kafka中，具体涉及几点：</p>

<ul>
  <li>Flume的插件<code>plugins.d</code>，在重写的<code>flume-win.bat</code>脚本中，并没有去扫描插件目录<code>plugins.d</code>，并且在<code>-cp</code>选项后通过<code>:</code>添加路径的目录，将导致<code>flume-win.bat</code>找不到Class，而直接使用<code>-cp %FLUME_HOME%\lib\*</code><em>（集中目录）</em> 就能够找到class。<strong>RE</strong>：Win下应该<code>-cp</code>选项应该使用<code>;</code>分隔，无论是Win的CMD环境，还是Cygwin环境，都应用<code>;</code>来分隔jar包；Linux下<code>-cp</code>选项，需要使用<code>:</code>来分隔jar包。</li>
</ul>

<h2 id="windows-server-2008">Windows Server 2008</h2>

<p>Windows Server 2008 与Windows XP基本相同，只需要调整一下<code>logToKafka.properties</code>脚本中sources部分，将command由<code>tail</code>（UnxUtils）替换为<code>get-content</code>（powershell），因为UnxUtils下的<code>tail</code>命令，在Windows Server 2008环境下，在Flume的source中时，无法捕获日志内容。<strong>（很奇怪，原因不明）</strong></p>

<p><strong>原因定位</strong>：在windows下，<code>tail -f</code>命令无法使用的原因，初步确定是因为，<code>tail -f</code>进程没有及时向Flume agent进程返回数据，而是在<code>tail</code>命令执行结束时，才将所有的内容一起返回；具体，可以监控<code>tail</code>命令，会出现内容已经发到Flume agent的现象。</p>

<h2 id="windows-7">Windows 7</h2>

<p>vdisk中flume目录下，有专门文档；</p>



        <div id="disqus_container">
            <div style="margin-bottom:20px" class="right">
				<wb:share-button appkey="2306590132" addition="simple" type="button" ralateUid="2356527183"></wb:share-button>
            </div>
            <!--<a href="#" class="comment" onclick="return false;">点击查看评论</a>-->
            <div id="disqus_thread"></div>
        </div>
    </div>

	
    <div class="sidenav">
		<iframe width="100%" height="75" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=550&fansRow=2&ptype=1&speed=0&skin=1&isTitle=0&noborder=0&isWeibo=0&isFans=0&uid=2356527183&verifier=1ccfb61e&colors=d6f3f7,ffffff,666666,0082cb,ecfbfd&dpc=1"></iframe>
    </div>

</div>

<script src="/js/post.js" type="text/javascript"></script>


	<div id="gotoTop">Top</div>


    <!--*********************************************************-->
    <!--****** 宝贝儿，看见这个时候，删掉下面的统计代码哦~ ******-->
    <!--*********************************************************-->
	<script>
	  (function(i,s,o,g,r,a,m){
		  i['GoogleAnalyticsObject']=r;i[r]=i[r] || function(){
			(i[r].q=i[r].q||[]).push(arguments)}, i[r].l=1*new Date();
			a=s.createElement(o), m=s.getElementsByTagName(o)[0];
			a.async=1;
			a.src=g;
			m.parentNode.insertBefore(a,m)
	  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	  ga('create', 'UA-48535193-1', 'ningg.github.io');
	  ga('send', 'pageview');
	</script>
    
	
    <script type="text/javascript">
		function gotoTop(min_height){
			$("#gotoTop").click(
				function(){$('html,body').animate({scrollTop:0},700);
			}).hover(
				function(){$(this).addClass("hover");},
				function(){$(this).removeClass("hover");
			});
			min_height ? min_height = min_height : min_height = 600;
			$(window).scroll(function(){
				
				var s = $(window).scrollTop();
				
				if( s > min_height){
					$("#gotoTop").fadeIn(100);
				}else{
					$("#gotoTop").fadeOut(200);
				};
			});
		};
		gotoTop();

        $(function(){
            $('.home-follow').click(function(e){
                e.preventDefault();

                if($('.home-contact').is(':visible')){
                    $('.home-contact').slideUp(100);
                }else{
                    $('.home-contact').slideDown(100);
                }
            });
        })

    </script>
</body>
</html>
