<!DOCTYPE html>
<html xmlns:wb="http://open.weibo.com/wb">
<head>
    <!--   Author: NingG   -->
    <meta charset="utf-8" />
	<meta property="wb:webmaster" content="7ea7f3d5f3edad6a" />
    <title>MySQL--基本操作 | ningg.top</title>
    <meta name="author" content="NingG" />
    <meta name="renderer" content="webkit">
    <meta name="description" content=" 开源的数据库MySQL的常用操作、内部原理  " />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">

    <link rel="stylesheet" href="/css/default.css" type="text/css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="alternate" type="application/atom+xml" title="Recent Entries" href="" />
	
    <script src="/js/jquery-1.7.1.min.js" type="text/javascript"></script>
	<script src="http://tjs.sjs.sinajs.cn/open/api/js/wb.js" type="text/javascript" charset="utf-8"></script>
	<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</head>
<body>
	
    <div class="home-menu">
        <div class="home-icon-con">
            <a class="home-menu-icon" href="/">NingG</a>
            <a class="home-follow" href="#" title="Contact Me">+</a>
        </div>
        <div class="home-contact">
            <a href="http://weibo.com/ggningg/" target="_blank" style="margin-left:-5px;"><img src="http://www.weibo.com/favicon.ico" alt="" width="25"/></a>
            <a href="http://www.douban.com/people/ggningg/" target="_blank" style="text-align:center;"><img src="http://www.douban.com/favicon.ico" alt="" width="22"/></a>
			<a href="http://github.com/ningg" alt="" target="_blank" style="text-align:right;"><img src="/images/icon-cube-smaller.png" width="22"/></a>
        </div>
    </div>

    <link rel="stylesheet" href="/js/prettify/prettify.css" />
<style type="text/css">
    body { background:#e8e8e8; }
    @media screen and (max-width: 750px){
        body { background:#fff; }
    }
    @media screen and (max-width: 1020px){
        body { background:#fff; }
    }
</style>

<div id="content">
    <div class="entry">
        <h1 class="entry-title"><a href="/mysql-basic-info" title="MySQL--基本操作">MySQL--基本操作</a></h1>
        <p class="entry-date">2013-01-16</p>
        <h2 id="section">简介</h2>

<p>难得最近两天重新接触Mysql，正好整理一下基本的知识。下面是自己本篇文章的大纲：</p>

<ol>
  <li>增删改查；</li>
  <li><code>group by</code>、<code>order by</code>、<code>distinct</code>；</li>
  <li>常用函数：<code>count()</code>、<code>min()</code>、<code>max()</code>、<code>substing_index()</code>等；</li>
  <li>查看mysql日志，主要是针对<code>warings</code>`errors`的查询和处理；</li>
  <li>mysql存储过程；</li>
  <li>数据备份；</li>
  <li>常用工具的介绍及特点；</li>
  <li>（万佛归宗）MySQL的整体框架，备份时内部的线程机制，语句执行效率。</li>
</ol>

<p>首先对于上面的8个要点进行一个整体的说明：<code>1-3</code>是基本的操作；<code>4-7</code>属于较深入的学习（有点难度），但仍然是操作过程；<code>8</code>是整个MySQL的基础，最核心的东西，从这里就可以窥见Mysql的起源了。操作部分关键是要记忆+操作；底层的理论需要一些理解（brain power）。</p>

<p><strong>说明</strong>：整篇的表述，都是以自己浅显的理解为基础的；有描述不当的地方，还请留言指正。</p>

<h2 id="section-1">具体</h2>

<h3 id="section-2">1.增删改查</h3>

<p>（todo）</p>

<h3 id="group-byorder-bydistinct">2.group by、order by、distinct</h3>

<p>（todo）</p>

<h3 id="countminmaxsubstringindex">3.常用函数：count、min、max、substring_index</h3>

<p>前3项，参照下面链接，把命令反复敲2遍，重复的也要敲。</p>

<ol>
  <li><a href="http://www.cnblogs.com/hateislove214/archive/2010/11/05/1869889.html">MySQL常用命令汇总1</a></li>
  <li><a href="http://zhaofeng2007625.blog.163.com/blog/static/311815972010111512437937/">MySQL常用命令汇总2</a></li>
  <li><a href="http://blog.sina.com.cn/s/blog_9707fac301017kb3.html">MySQL常用命令汇总3</a></li>
</ol>

<p><strong>NOTE</strong>:有疑问的地方多GOOGLE，实在无法解决的，就跳过。
简要说明几点（查找《MySQL必知必会》中对应部分）：</p>

<p><code>group by </code>分组，本质将表格分为逻辑组，基于逻辑组，同时进行相同处理（统计、汇总等）；可以嵌套分组，（效率很低的嵌套分组，过滤分组）常在group by之后，添加一个order by，按照某种规律进行排序。</p>

<p><code>order by</code> 排序，按多个列排序：order by column_1,column_2；DESC:降序；ASC：默认值，升序。（多列排序、指定排序方向）</p>

<p><code>distinct</code> 过滤重复内容；可以使用distinct column_1,column_2；（多列去重）</p>

<p><code>select</code>语句最后添加“\G”，会以列的格式来显示行。</p>

<p><code>alter</code>：修改表结构等。</p>

<h3 id="section-3">4.日志</h3>

<p><strong>读日志是熟悉使用一个工具的最基本要求</strong>。如果执行了一个sql脚本之后，提示<code>n warnings</code>，可以使用<code>show warnings</code>命令来查看详细信息。</p>

<p>假设场景：</p>

<ul>
  <li>现在mysql运行，希望知道哪些sql命令正在运行；（正在执行的命令）</li>
  <li>现在mysql运行，希望知道曾经执行过的sql命令；（历史命令）</li>
  <li>运行出现问题，mysql无法正常使用，现在希望查看mysql的运行日志；</li>
</ul>

<p>查看mysql的运行状态，命令：status；结果如下：</p>

<pre><code>mysql&gt; status;
--------------
mysql  Ver 14.14 Distrib 5.1.60, for redhat-linux-gnu (x86_64) using readline 5.1
 
Connection id:          21449
Current database:       chinacache
Current user:           root@localhost
SSL:                    Not in use
Current pager:          stdout
Using outfile:          ''
Using delimiter:        ;
Server version:         5.1.60 Source distribution
Protocol version:       10
Connection:             Localhost via UNIX socket
Server characterset:    utf8
Db     characterset:    utf8
Client characterset:    utf8
Conn.  characterset:    utf8
UNIX socket:            /home/data/mysqlData/mysql5.5.sock
Uptime:                 33 days 9 min 48 sec
 
Threads: 9  Questions: 15701727  Slow queries: 47  Opens: 1039  Flush tables: 1  Open tables: 541  Queries per second avg: 5.505
--------------
</code></pre>

<p>注意看，上面最后一行<code>slow queries</code>这一项的值，如果多次查看的值都大于0，则说明有些查询的sql命令执行时间过长。</p>

<p>查看当前正在运行的SQL，使用命令<code>show processlist；</code>，从中找出运行较慢的语句，再使用<code>explain</code>命令查看这些语句的执行计划。如下：</p>

<pre><code>mysql&gt; show processlist;
+-------+------+----------------------+------------+---------+------+----------------+-
| Id    | User | Host                 | db         | Command | Time | State          |
+-------+------+----------------------+------------+---------+------+----------------+-
| 21185 | root | localhost            | chinacache | Sleep   | 3744 |                | 
| 21449 | root | localhost            | chinacache | Sleep   |  501 |                | 
| 21626 | root | localhost            | chinacache | Query   |    0 | NULL           | 
| 21630 | root | localhost            | chinacache | Query   |    0 | Sorting result | 
| 21695 | root | localhost            | chinacache | Sleep   |  685 |                | 
| 21732 | zuo  | 10.108.210.111:50198 | chinacache | Sleep   |   19 |                | 
| 21733 | zuo  | 10.108.210.111:50201 | chinacache | Sleep   |  258 |                | 
| 21742 | zuo  | 10.108.210.111:50229 | chinacache | Sleep   |   19 |                | 
| 21744 | root | localhost            | wordpress  | Sleep   |    6 |                | 
+-------+------+----------------------+------------+---------+------+----------------+-
9 rows in set (0.00 sec)
</code></pre>

<p>对于MySQL的历史命令：需要在<code>my.cnf</code>文件中添加:</p>

<pre><code>[mysqld]
log=command.log
</code></pre>

<p>重新启动<code>mysqld</code>，之后所有的命令都可以到上述文件中查询得到。</p>

<p>查看当前启用的日志[7]，以及日志的存储路径：</p>

<pre><code>show variables like ‘log_%’;
</code></pre>

<h3 id="mysqlprocedure">5.mysql存储过程（procedure）</h3>

<p>什么是<code>mysql的存储过程</code>[1][2][3]？简单的说，为方便使用而保存的一条或者多条MySQL语句的集合，就是一个sql脚本文件，有输入\出参数，根据参数来动态执行其内部SQL语句（存储过程，实际是一种函数）。</p>

<pre><code>DELIMITER //
-- Name:ordertotal
-- Parameters:onumber = order number
--            taxable = 0 if not taxable, 1 if taxable
--            ototal = order total variable
CREATE PROCEDURE ordertotal(
		  IN onumber INT,
		  IN taxable BOOLEAN,
		  OUT ototal DECIMAL(8,2)
)COMMENT 'Obtain order total, optionally adding tax'
BEGIN
 
-- Declare variable for total
DECLARE total DECIMAL(8,2);
-- Declare tax percentage
DECLARE taxrate INT DEFAULT 6;
 
-- Get the order total
SELECT SUM(item_price*quantity)
		FROM ordertimes WHERE order_num = onumber INTO total;
 
-- Is this taxable?
IF taxable THEN 
		-- YES, so add taxrate to the total
		SELECT total+(total/100*taxrate) INTO total;
END IF;
 
-- And finally, save to our variable
SELECT total INTO ototal;
 
END //
 
DELIMITER ;
</code></pre>

<p>看上面简单的<code>存储过程</code>[1]，以此为例进行说明：首先，从意识上将上面的存储过程，看做一个函数。</p>

<p>具体细节：</p>

<ul>
  <li><code>DELIMITER //</code>表示暂时更改分隔符（mysql内判断为开始执行的分隔符）；</li>
  <li><code>–- </code>（最后有一个空格）表示单行注释；</li>
  <li>上面的<code>procedure</code>包含了2个输入参数（IN）和一个返回参数（OUT）；</li>
  <li>过程body中，使用<code>declare</code>定义了2个局部变量，<code>declare</code>要求使用变量名和类型；<code>select… into…</code> 语句将查询结果保存到<code>into</code>后面的变量中；</li>
  <li><code>if…then…end</code> if语句表示了是否一个条件判断执行过程。</li>
</ul>

<p><strong>补充</strong>：<code>procedure</code>的参数后面有<code>COMMENT</code>类似于备注，当使用<code>SHOW PROCEDURE STATUS;</code>时可以看到此字段。</p>

<p><strong>NOTE</strong>:注意存储过程中的<strong>输入参数</strong> 不能作为表名（<code>table name</code>）,如果必须将表名当做输入参数，可以使用预处理机制：<code>PREPARE</code>、<code>EXECUTE</code>、<code>DEALLOCATE PREPARE</code>。具体借鉴另一篇blog<a href="/mysql-data-cleaning/">MYsql——数据去重</a>。</p>

<p><strong>NOTE</strong>:上面使用<code>DECLARE</code>进行变量的声明，在很多情况下会看到<code>set @var</code>类型的变量，关于变量详细信息参考[5]（猜测只是变量的作用范围不同，其他的本质都是变量，没有什么不同？）。</p>

<p>常用的操作：</p>

<ul>
  <li>执行存储过程：<code>CALL procedure_name(params);</code></li>
  <li>删除存储过程：<code>DROP PROCEDURE procedure_name;</code>（<code>DROP PROCEDURE IF EXISTS procedure_name;</code>）</li>
  <li>显示所有正在运行的存储过程：<code>SHOW PROCEDURE STATUS</code>;其中包含了<code>procedure</code>的名称、创建时间、修改时间等;</li>
  <li>显示存储过程的创建语句：<code>SHOW CREATE PROCEDURE procedure_name</code>;</li>
</ul>

<h3 id="section-4">6.数据备份（操作）</h3>

<p>(doing…)</p>

<h3 id="section-5">7.常用工具</h3>

<p>(doing…)</p>

<h3 id="mysql">8.(万佛归宗)Mysql整体框架，内部线程机制，语句执行效率</h3>

<p>(doing…)</p>

<h2 id="section-6">常见问题</h2>

<h3 id="table">查看Table的建表语句</h3>

<p>执行如下SQL语句即可：</p>

<pre><code>&gt; show create table student;
&gt;
| student | CREATE TABLE `student` (
  `studentzj` varchar(11) NOT NULL COMMENT '主键',
  `studentid` varchar(5) NOT NULL,
  `name` varchar(20) NOT NULL,
  `gender` char(1) DEFAULT NULL,
  `birthday` date DEFAULT NULL,
  PRIMARY KEY (`studentzj`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8   |
</code></pre>

<h2 id="section-7">参考来源</h2>

<ol>
  <li>《MySQL必知必会》Page171</li>
  <li>http://blog.sina.com.cn/s/blog_71f4cdbe0100yut4.html</li>
  <li>http://www.ccvita.com/100.html</li>
  <li>http://www.ccvita.com/category/mysql/</li>
  <li>http://blog.csdn.net/lxgwm2008/article/details/7738306</li>
  <li>http://joewalker.iteye.com/blog/277626</li>
  <li>http://blog.sina.com.cn/s/blog_406127500100pvar.html</li>
</ol>



        <div id="disqus_container">
            <div style="margin-bottom:20px" class="right">
				<wb:share-button appkey="2306590132" addition="simple" type="button" ralateUid="2356527183"></wb:share-button>
            </div>
            <!--<a href="#" class="comment" onclick="return false;">点击查看评论</a>-->
            <div id="disqus_thread"></div>
        </div>
    </div>

	
    <div class="sidenav">
		<iframe width="100%" height="75" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=550&fansRow=2&ptype=1&speed=0&skin=1&isTitle=0&noborder=0&isWeibo=0&isFans=0&uid=2356527183&verifier=1ccfb61e&colors=d6f3f7,ffffff,666666,0082cb,ecfbfd&dpc=1"></iframe>
    </div>

</div>

<script src="/js/post.js" type="text/javascript"></script>


	<div id="gotoTop">Top</div>


    <!--*********************************************************-->
    <!--****** 宝贝儿，看见这个时候，删掉下面的统计代码哦~ ******-->
    <!--*********************************************************-->
	<script>
	  (function(i,s,o,g,r,a,m){
		  i['GoogleAnalyticsObject']=r;i[r]=i[r] || function(){
			(i[r].q=i[r].q||[]).push(arguments)}, i[r].l=1*new Date();
			a=s.createElement(o), m=s.getElementsByTagName(o)[0];
			a.async=1;
			a.src=g;
			m.parentNode.insertBefore(a,m)
	  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	  ga('create', 'UA-48535193-1', 'ningg.github.io');
	  ga('send', 'pageview');
	</script>
    
	
    <script type="text/javascript">
		function gotoTop(min_height){
			$("#gotoTop").click(
				function(){$('html,body').animate({scrollTop:0},700);
			}).hover(
				function(){$(this).addClass("hover");},
				function(){$(this).removeClass("hover");
			});
			min_height ? min_height = min_height : min_height = 600;
			$(window).scroll(function(){
				
				var s = $(window).scrollTop();
				
				if( s > min_height){
					$("#gotoTop").fadeIn(100);
				}else{
					$("#gotoTop").fadeOut(200);
				};
			});
		};
		gotoTop();

        $(function(){
            $('.home-follow').click(function(e){
                e.preventDefault();

                if($('.home-contact').is(':visible')){
                    $('.home-contact').slideUp(100);
                }else{
                    $('.home-contact').slideDown(100);
                }
            });
        })

    </script>
</body>
</html>
