<!DOCTYPE html>
<html xmlns:wb="http://open.weibo.com/wb">
<head>
    <!--   Author: NingG   -->
    <meta charset="utf-8" />
	<meta property="wb:webmaster" content="7ea7f3d5f3edad6a" />
    <title>Pig入门1h | ningg.top</title>
    <meta name="author" content="NingG" />
    <meta name="renderer" content="webkit">
    <meta name="description" content=" Pig，Hadoop生态体系中，数据处理利器  " />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">

    <link rel="stylesheet" href="/css/default.css" type="text/css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="alternate" type="application/atom+xml" title="Recent Entries" href="" />
	
    <script src="/js/jquery-1.7.1.min.js" type="text/javascript"></script>
	<script src="http://tjs.sjs.sinajs.cn/open/api/js/wb.js" type="text/javascript" charset="utf-8"></script>
	<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</head>
<body>
	
    <div class="home-menu">
        <div class="home-icon-con">
            <a class="home-menu-icon" href="/">NingG</a>
            <a class="home-follow" href="#" title="Contact Me">+</a>
        </div>
        <div class="home-contact">
            <a href="http://weibo.com/ggningg/" target="_blank" style="margin-left:-5px;"><img src="http://www.weibo.com/favicon.ico" alt="" width="25"/></a>
            <a href="http://www.douban.com/people/ggningg/" target="_blank" style="text-align:center;"><img src="http://www.douban.com/favicon.ico" alt="" width="22"/></a>
			<a href="http://github.com/ningg" alt="" target="_blank" style="text-align:right;"><img src="/images/icon-cube-smaller.png" width="22"/></a>
        </div>
    </div>

    <link rel="stylesheet" href="/js/prettify/prettify.css" />
<style type="text/css">
    body { background:#e8e8e8; }
    @media screen and (max-width: 750px){
        body { background:#fff; }
    }
    @media screen and (max-width: 1020px){
        body { background:#fff; }
    }
</style>

<div id="content">
    <div class="entry">
        <h1 class="entry-title"><a href="/introduction-to-pig" title="Pig入门1h">Pig入门1h</a></h1>
        <p class="entry-date">2014-05-08</p>
        <blockquote>
  <p>开篇先推荐一个PPT：<a href="/download/pig/introduction-to-pig.pptx" title="Pig简介，原理，简要说明">Pig简介</a>，简要介绍了Pig的基本原理，重点说明了其与MapReduce的关系。</p>
</blockquote>

<p><strong>副标题</strong>: Pig入门 <em>_之_</em> 乱拳打死老师傅</p>

<h2 id="section">从副标题展开说</h2>

<p>先说一下为什么起这么一个副标题：前几天看电视剧消遣，有个小年轻，被质疑没有经验怎么办的时候，自己吹牛打气，说“我啥也不会，乱拳打死老师傅…”；这个，倒不是说对师傅的不尊敬，而是民间俗语，大概意思是：啥也不会的情况下，受领域内固有思想、规则约束的少，敢打敢拼，敢于突破陈规，往往能够带来新气象。<em>（不是要煽动大家起义、造反，而是，鼓励勇于突破、敢为天下先）。</em></p>

<p>Pig知识的学习\介绍，大部分人会按照如下思路开展：</p>

<ol>
  <li>Pig解决什么问题；<em>（pig产生背景）</em></li>
  <li>Pig Latin语言的基本语法；<em>（配合一些基本操作）</em></li>
  <li>Pig Latin语言的高级语法；<em>（针对一些特有的、容易出错的用法，进行详细介绍）</em></li>
  <li>Pig脚本的调试；<em>（脚本不是一气呵成的，需要一些调试分析手段）</em></li>
  <li>Pig的可扩展部分；<em>（Pig提供的内建函数，无法满足需求时，需要自己动手来实现Pig的对外接口）</em></li>
  <li>Pig性能调优；<em>（上面所有的步骤，都在说如何去使用Pig来完成一件事，现在会说一下如何把事做好、做漂亮）</em></li>
</ol>

<p>需要这么多吗？学个东西，有这么复杂吗？<em>（上面开展的思路，是为了循序渐进、由浅入深，让你从原理到操作，能有一个全面的理解和掌握，嗯，一句话：为你好，才这么安排的）</em></p>

<p>纳尼？我想说，你能直接一点么？上面<code>1、2、3、4、5、6</code>，看起来头都大了，唉，我只想使用Pig，不想知道他是怎么来的。</p>

<p>妥了，是个爽快的人，也算志同道合了，不多说：直接开始一步一步用Pig，让那些乱七八糟的东西见鬼去吧。</p>

<p><img src="/images/introduction-to-pig/pig-logo.jpg" alt="pig-logo" /></p>

<h2 id="pig">Pig用起来</h2>

<h3 id="section-1">一个例子</h3>

<p>准备数据文件<code>student</code>：</p>

<pre><code>$cat student
Jun L. 	18	3.7
Hhui H.	18	3.8
Ning G.	20	3.6
Hlong G.	22	3.6
Chang W.	21	3.6
</code></pre>

<p>注：上述文件中，3列分别表示：姓名、年龄、GPA，他们之间都以TAB键分隔；</p>

<p>目标：求20岁以下和20岁以上的学生的人数以及gpa平均值</p>

<p>进入执行Pig 脚本的交互模式：</p>

<pre><code>$pig –x local
</code></pre>

<p>逐行输入如下pig脚本(<code>student_avg_gpa.pig</code>)：</p>

<pre><code>studentInfos = load ’student’ as (name: chararray, age:int, gpa:float);
studentBag = group studentInfos all;
result = foreach studentBag {
  student_younger = filter studentInfos by age &lt;= 20;
  student_older = filter studentInfos by age &gt; 20;
  generate COUNT(studentInfos) as totalNum, AVG(studentInfos.gpa) as avgGPA, 
	COUNT(student_younger) as youngerNum, AVG(student_younger.gpa) as youngerAvgGPA, 
	COUNT(student_older) as olderNum, AVG(student_older.gpa) as olderAvgGPA;
}
dump result;
</code></pre>

<p><strong>备注</strong>：可以将上面的脚本写在文件<code>student_avg_gpa.pig</code>内，在<code>grunt</code>交互场景下使用命令：<code>run &lt;pigScript&gt;</code> 来执行脚本。</p>

<p>看到结果了吗？</p>

<p><code>(5,3.659999942779541,3,3.699999968210856,2,3.5999999046325684)</code></p>

<p>总共6个值（<code>,</code>逗号分割）。</p>

<p>对于结果的说明：</p>

<ol>
  <li>总共5人；平均GPA：约3.66；</li>
  <li>20岁以下（包含20岁）3人；平均GPA：约3.70；（pig对于float数据运算有误差）</li>
  <li>20岁以上2人；平均GPA：约3.60；</li>
</ol>

<p>简要说一下：</p>

<pre><code>grunt&gt; studentInfos = load ‘student’ as (name: chararray, age:int, gpa:float);
</code></pre>

<p>其中，<code>load</code>为加载数据的关键字，<code>student</code>表示数据文件位置，<code>as</code> 关键字为前面数据文件指定field别名和field类型。</p>

<p>可以使用如下命令，来查看一个<code>studentInfos</code>的数据结构：</p>

<pre><code>grunt&gt; describe studentInfos
studentInfos: {name: chararray,age: int,gpa: float}
</code></pre>

<p>使用如下命令，查看<code>studentInfos</code>的具体内容：</p>

<pre><code>grunt&gt; dump studentInfos;
(Jun L.,18,3.7)
(Hhui H.,18,3.8)
(Ning G.,20,3.6)
(Hlong G.,22,3.6)
(Chang W.,21,3.6)
</code></pre>

<p>上面 <code>describe</code>、<code>dump</code>命令输出的内容到底是什么玩意儿？</p>

<p>我们来解释一下：</p>

<pre><code># describe studentInfos 命令输出如下：
studentInfos: {name: chararray,age: int,gpa: float}
</code></pre>

<p>表示显示<code>studentInfos</code>的结构：</p>

<ol>
  <li><code>studentInfos</code>是一个<code>relation</code>，因为<code>studentInfos:{}</code>在冒号后指向了花括号<code>{}</code>，这是一个<code>relation</code>的标识；</li>
  <li><code>studentInfos</code>内，<code>tuple</code>的结构为：<code>(name: chararray,age: int,gpa: float)</code>，即，包含3个字段，依次为<code>name</code>、<code>age</code>、<code>gpa</code>，名字后<code>:</code>之后字段对应的类型；</li>
</ol>

<p>上面提到的<code>relation</code>、<code>tuple</code>是什么？从哪冒出来的？客官莫要着急，<code>relation</code>、<code>tuple</code>都是<code>Pig</code>内部的几个概念，且听我慢慢道来。</p>

<p>Pig定义了几个基本概念，用于描述数据结构：</p>

<ol>
  <li><code>field</code>，字段，某一位置的数据，即，<code>(Jun L.,18,3.7)</code>中包含了3个字段；类似RDBMS中Table中一行数据的一个字段；</li>
  <li><code>tuple</code>，元组，是<code>field</code>的有序组合，使用<code>()</code>来标识，即，<code>(Jun L.,18,3.7)</code>表示一个<code>tuple</code>；类似RDBMS中Table中一行数据；</li>
  <li><code>bag</code>，包，是<code>tuple</code>的无序组合，使用<code>{}</code>来标识，即，<code>{(Jun L.,18,3.7),(Hhui H.,18,3.8)}</code> 表示包含2个<code>tuple</code>的一个<code>bag</code>；类似RDBMS中的一个Table；</li>
  <li><code>relation</code>，关系，<code>outer bag</code>，在此，暂时将<code>relation</code>与<code>bag</code>等价看待；</li>
</ol>

<p><strong>补充</strong>：<code>field</code>可以为任何类型，即，<code>tuple</code>、<code>bag</code>都可以作为<code>field</code>，包含在<code>tuple</code>中。</p>

<p>现在再回过头看一下，<code>studentInfos</code>的结构：</p>

<pre><code>grunt&gt; describe studentInfos
studentInfos: {name: chararray,age: int,gpa: float}
</code></pre>

<p>是不是很明朗了？<em>（什么？还不明朗？把上面的分析读3遍）</em></p>

<p>有人问<code>studentInfos: {name: chararray,age: int,gpa: float}</code>中，<code>studentInfos</code>这个<code>relation</code>内部不应该是<code>tuple</code>吗？<code>tuple</code>不是应该以<code>()</code>标识吗？为什么不是<code>studentInfos: {(name: chararray,age: int,gpa: float)}</code>？这是因为<code>studentInfos</code>中的<code>tuple</code>不在一行，是分行输出的，下面会看到如果<code>relation</code>中<code>tuple</code>都在一行的情景。</p>

<p>将<code>studentInfos</code>按照所有字段进行<code>group</code>，即使有某2个<code>tuple</code>内容完全一致，也会统计为2个<code>tuple</code>，即，本质上<code>group..all</code>是将多行数据合并为一行。</p>

<pre><code>grunt&gt; studentBag = group studentInfos all;

grunt&gt; describe studentBag;
studentBag: {group: chararray,studentInfos: {(name: chararray,age: int,gpa: float)}}

grunt&gt; dump studentBag;
(all,{(Jun L.,18,3.7),(Hhui H.,18,3.8),(Ning G.,20,3.5),(Hlong G.,22,3.6),(Chang W.,21,3.6)})
</code></pre>

<p><strong>补充</strong>：<code>group</code>操作时，会生成一个<code>field</code>，命名为<code>group</code>，可以尝试如下命令：</p>

<pre><code>grunt&gt; test = group studentInfos by age;

grunt&gt; describe test;
test: {group: int,studentInfos: {(name: chararray,age: int,gpa: float)}}

grunt&gt; dump test;
(18,{(Jun L.,18,3.7),(Hhui H.,18,3.8)})
(20,{(Ning G.,20,3.6)})
(21,{(Chang W.,21,3.6)})
(22,{(Hlong G.,22,3.6)})
</code></pre>

<p>上面的命令：<code>load</code>、<code>group</code>多少有些过于简单，不刺激，不激动，下面的命令会有点意思：</p>

<pre><code>grunt&gt; result = foreach studentBag {
&gt;&gt;   student_younger = filter studentInfos by age &lt;= 20;
&gt;&gt;   student_older = filter studentInfos by age &gt; 20;
&gt;&gt;   generate COUNT(studentInfos) as totalNum, AVG(studentInfos.gpa) as avgGPA, 
		COUNT(student_younger) as youngerNum, AVG(student_younger.gpa) as youngerAvgGPA, 
		COUNT(student_older) as olderNum, AVG(student_older.gpa) as olderAvgGPA;
&gt;&gt; }
</code></pre>

<p>有点复杂？稍等，拆解一下，再复杂的命令也会变得简单：</p>

<pre><code>student_younger = filter studentInfos by age &lt;= 20;
</code></pre>

<p><code>filter..by..</code>是过滤语句，此处，表示按照条件<code>age &lt;= 20</code>过滤出不到20岁的学生，并且将结果指定给<code>student_younger</code>。</p>

<pre><code>generate COUNT(studentInfos) as totalNum, AVG(studentInfos.gpa) as avgGPA, 
	COUNT(student_younger) as youngerNum, AVG(student_younger.gpa) as youngerAvgGPA, 
	COUNT(student_older) as olderNum, AVG(student_older.gpa) as olderAvgGPA;
</code></pre>

<p>上面这个<code>generate ..</code>是生成数据的命令，<code>COUNT</code>、<code>AVG</code>都是内部提供的聚合函数，看其中的一个命令：</p>

<pre><code>generate COUNT(studentInfos) as totalNum, AVG(studentInfos.gpa) as avgGPA;
</code></pre>

<p>表示将<code>studentInfos</code>中包含的学生个数，以及所有学生的<code>gpa</code>平均值，组合成一个<code>tuple</code>，赋值给<code>result</code>；<code>as..</code> 关键字为这些<code>field</code>指定名字。</p>

<pre><code>grunt&gt; describe result;
result: {totalNum: long,avgGPA: double,youngerNum: long,youngerAvgGPA: double,olderNum: long,olderAvgGPA: double}

grunt&gt; dump result;
(5,3.6399999618530274,3,3.6666666666666665,2,3.5999999046325684)
</code></pre>

<p><strong>建议</strong>：把上面的例子，再输入执行2遍，多使用<code>describe</code>、<code>dump</code>命令配合查看执行过程。</p>

<h3 id="section-2">练习一下</h3>

<p>还是上面的<code>student</code>数据</p>

<pre><code>$cat student
Jun L. 	18	3.7
Hhui H.	18	3.8
Ning G.	20	3.6
Hlong G.	22	3.6
Chang W.	21	3.6
</code></pre>

<p>注：上述文件中，姓名、年龄、GPA之间都以TAB键分隔；</p>

<p><strong>目标</strong>：20岁以下学生的人数以及gpa平均值，以及这些学生的名字（要求只算出这些，其他东西不要求）。</p>

<p>这就成了上面问题的一部分，可以使用如下pig脚本：</p>

<pre><code>-- 加载数据、设定field名字、设定field类型
studentInfos = load ’student’ as (name: chararray, age:int, gpa:float);

-- 找出20岁以下的学生
student_younger = filter studentInfos by age &lt;= 20;

-- 要调用聚合函数COUNT\AVG必须进行group，将所有列，转换为一行
student_younger_bag = group student_younger all;

-- 输出学生人数、平均GPA，以及学生名单(下一条命令实际为一行)
result = foreach student_younger_bag generate COUNT(student_younger),
 AVG(student_younger.gpa), student_younger.name;

dump result;
</code></pre>

<p>输出结果为：</p>

<p><code>(3,3.699999968210856,{(Jun L.),(Hhui H.),(Ning G.)})</code></p>

<h2 id="section-3">一篇博文</h2>

<p>推荐codelast的一篇博文<a href="http://www.codelast.com/?p=3621">Apache Pig基础概念及用法</a>, 不要着急，放松放松，CodeLast的这篇博客很轻松，嗯，很适合入门，在此向原博主致敬。</p>

<h2 id="section-4">参考来源</h2>

<ul>
  <li><a href="http://www.codelast.com/?p=4550">codeLast Apache Pig学习系列</a>
<em>（个人看法：非常不错，适合直接上手写pig脚本；）</em></li>
  <li><a href="http://book.douban.com/subject/21357721/">Pig编程指南</a>（Alan Gates著， 曹坤 译， 2013年2月  第1版） 
<em>(个人看法：有理论、有深度、有广度，每次都有新感觉；)</em></li>
  <li><a href="http://pig.apache.org/docs/r0.12.1/">Pig documentation</a>，
<em>(个人看法：特别详细，想要的东西，基本都能从这里找到，而且更新速度很快；)</em></li>
</ul>

<blockquote>
  <p>由于Pig版本迭代速度比较快，所以个人建议，最好能去官网查看文档。</p>
</blockquote>

<p><img src="/images/introduction-to-pig/pig-on-elephant.png" alt="pig-on-elephant" /></p>



        <div id="disqus_container">
            <div style="margin-bottom:20px" class="right">
				<wb:share-button appkey="2306590132" addition="simple" type="button" ralateUid="2356527183"></wb:share-button>
            </div>
            <!--<a href="#" class="comment" onclick="return false;">点击查看评论</a>-->
            <div id="disqus_thread"></div>
        </div>
    </div>

	
    <div class="sidenav">
		<iframe width="100%" height="75" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=550&fansRow=2&ptype=1&speed=0&skin=1&isTitle=0&noborder=0&isWeibo=0&isFans=0&uid=2356527183&verifier=1ccfb61e&colors=d6f3f7,ffffff,666666,0082cb,ecfbfd&dpc=1"></iframe>
    </div>

</div>

<script src="/js/post.js" type="text/javascript"></script>


	<div id="gotoTop">Top</div>


    <!--*********************************************************-->
    <!--****** 宝贝儿，看见这个时候，删掉下面的统计代码哦~ ******-->
    <!--*********************************************************-->
	<script>
	  (function(i,s,o,g,r,a,m){
		  i['GoogleAnalyticsObject']=r;i[r]=i[r] || function(){
			(i[r].q=i[r].q||[]).push(arguments)}, i[r].l=1*new Date();
			a=s.createElement(o), m=s.getElementsByTagName(o)[0];
			a.async=1;
			a.src=g;
			m.parentNode.insertBefore(a,m)
	  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	  ga('create', 'UA-48535193-1', 'ningg.github.io');
	  ga('send', 'pageview');
	</script>
    
	
    <script type="text/javascript">
		function gotoTop(min_height){
			$("#gotoTop").click(
				function(){$('html,body').animate({scrollTop:0},700);
			}).hover(
				function(){$(this).addClass("hover");},
				function(){$(this).removeClass("hover");
			});
			min_height ? min_height = min_height : min_height = 600;
			$(window).scroll(function(){
				
				var s = $(window).scrollTop();
				
				if( s > min_height){
					$("#gotoTop").fadeIn(100);
				}else{
					$("#gotoTop").fadeOut(200);
				};
			});
		};
		gotoTop();

        $(function(){
            $('.home-follow').click(function(e){
                e.preventDefault();

                if($('.home-contact').is(':visible')){
                    $('.home-contact').slideUp(100);
                }else{
                    $('.home-contact').slideDown(100);
                }
            });
        })

    </script>
</body>
</html>
