<!DOCTYPE html>
<html xmlns:wb="http://open.weibo.com/wb">
<head>
    <!--   Author: NingG   -->
    <meta charset="utf-8" />
	<meta property="wb:webmaster" content="7ea7f3d5f3edad6a" />
    <title>Pig解析中文文档 | ningg.top</title>
    <meta name="author" content="NingG" />
    <meta name="renderer" content="webkit">
    <meta name="description" content=" 当处理的日志文档中包含中文时，该如何处理，有哪些注意事项  " />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">

    <link rel="stylesheet" href="/css/default.css" type="text/css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="alternate" type="application/atom+xml" title="Recent Entries" href="" />
	
    <script src="/js/jquery-1.7.1.min.js" type="text/javascript"></script>
	<script src="http://tjs.sjs.sinajs.cn/open/api/js/wb.js" type="text/javascript" charset="utf-8"></script>
	<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</head>
<body>
	
    <div class="home-menu">
        <div class="home-icon-con">
            <a class="home-menu-icon" href="/">NingG</a>
            <a class="home-follow" href="#" title="Contact Me">+</a>
        </div>
        <div class="home-contact">
            <a href="http://weibo.com/ggningg/" target="_blank" style="margin-left:-5px;"><img src="http://www.weibo.com/favicon.ico" alt="" width="25"/></a>
            <a href="http://www.douban.com/people/ggningg/" target="_blank" style="text-align:center;"><img src="http://www.douban.com/favicon.ico" alt="" width="22"/></a>
			<a href="http://github.com/ningg" alt="" target="_blank" style="text-align:right;"><img src="/images/icon-cube-smaller.png" width="22"/></a>
        </div>
    </div>

    <link rel="stylesheet" href="/js/prettify/prettify.css" />
<style type="text/css">
    body { background:#e8e8e8; }
    @media screen and (max-width: 750px){
        body { background:#fff; }
    }
    @media screen and (max-width: 1020px){
        body { background:#fff; }
    }
</style>

<div id="content">
    <div class="entry">
        <h1 class="entry-title"><a href="/pig-deal-with-chinese" title="Pig解析中文文档">Pig解析中文文档</a></h1>
        <p class="entry-date">2014-05-09</p>
        <p><code>Pig</code>处理文档时，<code>LOAD</code>和<code>STORE</code>默认数据是<code>UTF-8</code>编码格式（参考来源？官方文档/源码）。因此，包含中文字符的数据文档，应以<code>UTF-8</code>格式存储；相应的包含中文字符的pig脚本，也应以<code>UTF-8</code>格式存储。</p>

<p>本文简介：</p>

<ul>
  <li>中文文档如何转码，特别是<code>Linux</code>下利用<code>iconv</code>命令转码时的注意事项；</li>
  <li>使用<code>SecuryCRT</code>/<code>putty</code>客户端连接服务器时，中文文档显示乱码的解决办法；</li>
  <li>Pig脚本解析中文文档的步骤；</li>
</ul>

<h2 id="utf-8">将文档存储为UTF-8格式</h2>

<p>在<code>windows</code>下，可以使用<code>notepad++</code>来进行文档转码：
<code>Encoding</code>–<code>Convert to UTF-8 without BOM</code>，则当前文档转换为<code>UTF-8</code>编码方式。</p>

<p><img src="/images/pig-deal-with-chinese/convert-utf8.png" alt="convert-utf8" /></p>

<p>（思考：文档编码格式转换的原理？在linux下有没有类似的转换工具/命令？）</p>

<p><strong>补充</strong>：</p>

<p><code>Linux</code>下使用<code>iconv</code>可以进行编码格式转换，具体操作如下：</p>

<h3 id="section">查看文档编码方式：</h3>

<pre><code>file –i origin.txt
</code></pre>

<p><img src="/images/pig-deal-with-chinese/file-i.png" alt="file-i" /></p>

<h3 id="section-1">对文档转码：</h3>

<pre><code>// 下面命令中 origin.txt.utf8为输出文件。
iconv –f ISO-8859-1 –t UTF-8 &lt; origin.txt &gt; origin.txt.utf8
</code></pre>

<p><strong>特别说明</strong>：</p>

<p>如果<code>iconv</code>转码命令，出现<code>iconv: illegal input sequence at position 42</code>错误信息，则可以使用如下命令进行转码：</p>

<pre><code>iconv –f gbk –t UTF-8 &lt; origin.txt &gt; origin.txt.gbk
</code></pre>

<p>（思考：上面的原因是否是<code>file</code>命令查询结果不精确，查询文件的编码方式，<code>linux</code>下还有其他的命令吗？）</p>

<p>（思考：不同的编码格式的差异？为什么有多种编码？对应的应用场景？）</p>

<h3 id="iconv">iconv转码出错[重要]</h3>

<p>当对<code>1G</code>以上的大文件，进行转码时：如果按照如下命令进行转码：</p>

<pre><code>// 下面命令中 origin.txt.utf8为输出文件。
iconv –f gbk –t UTF-8 &lt; origin.txt &gt; origin.txt.utf8
</code></pre>

<p>可能仍然会出错：<code>iconv: illegal input sequence at position 91401042</code>，查看<code>origin.txt.utf8</code>文件，其内中文已经正常显示，只是原始文件在某个位置出现问题，没能完成整个文档的转码。</p>

<p>原因排查：是否是原始文件中真的有字符无法转码？还是文件过大？</p>

<p>排查措施：使用<code>split</code>、<code>head</code>等命令对文件分割之后，在相应位置仍然出错；</p>

<p>原因确定：是原始文件有非法字符，<code>GBK</code>中不存在的编码，<code>GBK</code>自己无法识别，因此无法转码。</p>

<p>解决途径：</p>

<ol>
  <li>删除有乱码的行？（使用wc –l 、 sed –i 等命令；） </li>
  <li>跳过有乱码的几个字符？</li>
  <li><code>iconv</code>有没有强制转换，忽略/跳过错误？（尼玛，恭喜你，猜对了，有这么个机制）</li>
  <li>使用 <code>man iconv</code>查询不到，应该使用<code>iconv –help</code>，查看命令的帮助。</li>
</ol>

<p>最终命令：</p>

<pre><code>iconv –f gbk –t utf-8//IGNORE &lt; input &gt; output 
</code></pre>

<p>搞定。</p>

<p>参考来源：</p>

<p>[1]	http://www.aiezu.com/system/linux/linux_iconv_code.html
[2] http://www.linuxquestions.org/questions/linux-newbie-8/usr-bin-iconv-illegal-input-sequence-at-position-905152/</p>

<h2 id="linux">将文档传到远端linux服务器</h2>

<p>注意：在传输过程中，应尽量保持文档的属性/编码方式保持不变。
仅仅是将<code>windows</code>下文档传递到远端linux服务器上，方法很多：<code>fileZilla</code>、<code>WinSCP</code>等，下面说一种不需要安装软件的方法（亲，不要想错了，需要下载软件的，只是软件很小，不需要安装）。
下载<code>PSCP</code>，文件300k，果真很小；现在工具有了，如何利用<code>PSCP</code>来向远端<code>linux</code>传送文件呢？操作如下：</p>

<pre><code>//-p : preserve file attributes.（传送过程中，保持文件属性不变）
scp –p originalFile user@ip:/home/user/destFold
</code></pre>

<p>上面命令会将本地<code>originalFile</code>文件，无失真传送到服务器<code>/home/user/destFold</code>目录下。</p>

<p>在远端<code>linux</code>服务器上，如何查看文档的具体编码方式呢？</p>

<pre><code>file –i filename
</code></pre>

<p>可以使用上述命令来确认文件的编码方式。</p>

<p>现在按照<code>utf-8</code>编码的文件，已经在服务器上了，那原材料就齐全了，开始处理吧。</p>

<h2 id="section-2">远端服务器上，中文显示乱码</h2>

<p>既然要操作远端<code>linux</code>服务器，最好要建立持久的连接，常用的方式：<code>putty</code>、<code>secureCRT</code>。然而，查看服务器上的中文文档时，可能出现乱码。</p>

<h3 id="section-3">服务器的基本环境</h3>

<p>针对上述情况，需要先检查一下服务器上设置的语言环境。</p>

<pre><code>echo $LANG
// 上述输出结果为：en_US.UTF-8

更进一步，查看3个文件，看LANG具体如何配置的：
cat /etc/sysconfig/i18n
//上述输出结果为：LANG=”en_US.UTF-8”

cat ~/.bash_profile
//上述输出结果中，没有LANG的配置

cat ~//.bashrc
//上述输出结果中，没有LANG的配置
</code></pre>

<p>（思考：LANG的配置有什么用？LANG不就是个环境变量吗？）</p>

<h3 id="putty">Putty连接服务器</h3>

<p>设置方式：
<code>Window</code>–<code>Translation</code>–<code>Character set translation</code>–<code>Remote character set</code>，选中“UTF-8”。</p>

<p><img src="/images/pig-deal-with-chinese/putty-utf8.png" alt="putty-utf8.png" /></p>

<p><code>Window</code>–<code>Appearance</code>–<code>Font settings</code>–<code>Font used in terminal window</code>，选中<code>Courier New</code>（尝试其他字体也可以解决中文乱码）。</p>

<p><img src="/images/pig-deal-with-chinese/putty-appearance.png" alt="putty-appearance" /></p>

<h3 id="securecrt">SecureCRT连接服务器</h3>

<p><code>选项</code>–<code>会话选项</code>–<code>终端</code>–<code>外观</code>–<code>字体</code>，<code>字符编码</code>选中<code>UTF-8</code>；
<code>标准字体</code>选中<code>幼圆</code>（宋体等其他也可以）</p>

<p><img src="/images/pig-deal-with-chinese/securecrt-appearance.png" alt="securecrt-appearance" /></p>

<p><img src="/images/pig-deal-with-chinese/securecrt-font.png" alt="securecrt-font" /></p>

<p>OK，到现在位置，使用<code>putty</code>/<code>secureCRT</code>连接远程服务器，再查看<code>UTF-8</code>编码的中文文档时，就不会出现乱码了。下面测试一下效果：</p>

<pre><code>less filename
</code></pre>

<p><img src="/images/pig-deal-with-chinese/less.png" alt="less.png" /></p>

<h2 id="pig">Pig脚本解析中文文档</h2>

<p>千呼万唤始出来、犹抱琵琶半遮面，使用pig来解析中文文档是本文的重点，却姗姗来迟。好的，先来回顾一下前面的工作：</p>

<ol>
  <li>将pig脚本<code>select_rows.pig</code>使用UTF-8格式编码、待分析的文档<code>sfzf.log</code>也使用<code>UTF-8</code>格式编码；</li>
  <li>将两个文件传送到linux服务器上，并且使用<code>file –i filename</code> 命令查看，确保其都为<code>UTF-8</code>的编码格式；</li>
  <li>设置<code>secureCRT</code>或者<code>putty</code>，保证其查阅中文文档时，无乱码；</li>
  <li>到这一步了，直接运行pig脚本<code>select_rows.pig</code>就可以了~哈哈（对，pig解析中文文档，就这么简单）；</li>
</ol>

<p>Pig脚本<code>select_rows.pig</code>内容如下：</p>

<pre><code>/* 查找输入文档中，包含关键字“时间”的行，并输出 */
A = load '$input' as (col1:chararray);
B = filter A by ($col1 matches '.*时间.*');

store B into '$output';
</code></pre>

<p>运行命令：</p>

<pre><code>pig –x local –param input=sfzf.log –param output=out4 select_rows.pig
</code></pre>

<p><img src="/images/pig-deal-with-chinese/result.png" alt="result" /></p>



        <div id="disqus_container">
            <div style="margin-bottom:20px" class="right">
				<wb:share-button appkey="2306590132" addition="simple" type="button" ralateUid="2356527183"></wb:share-button>
            </div>
            <!--<a href="#" class="comment" onclick="return false;">点击查看评论</a>-->
            <div id="disqus_thread"></div>
        </div>
    </div>

	
    <div class="sidenav">
		<iframe width="100%" height="75" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=550&fansRow=2&ptype=1&speed=0&skin=1&isTitle=0&noborder=0&isWeibo=0&isFans=0&uid=2356527183&verifier=1ccfb61e&colors=d6f3f7,ffffff,666666,0082cb,ecfbfd&dpc=1"></iframe>
    </div>

</div>

<script src="/js/post.js" type="text/javascript"></script>


	<div id="gotoTop">Top</div>


    <!--*********************************************************-->
    <!--****** 宝贝儿，看见这个时候，删掉下面的统计代码哦~ ******-->
    <!--*********************************************************-->
	<script>
	  (function(i,s,o,g,r,a,m){
		  i['GoogleAnalyticsObject']=r;i[r]=i[r] || function(){
			(i[r].q=i[r].q||[]).push(arguments)}, i[r].l=1*new Date();
			a=s.createElement(o), m=s.getElementsByTagName(o)[0];
			a.async=1;
			a.src=g;
			m.parentNode.insertBefore(a,m)
	  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	  ga('create', 'UA-48535193-1', 'ningg.github.io');
	  ga('send', 'pageview');
	</script>
    
	
    <script type="text/javascript">
		function gotoTop(min_height){
			$("#gotoTop").click(
				function(){$('html,body').animate({scrollTop:0},700);
			}).hover(
				function(){$(this).addClass("hover");},
				function(){$(this).removeClass("hover");
			});
			min_height ? min_height = min_height : min_height = 600;
			$(window).scroll(function(){
				
				var s = $(window).scrollTop();
				
				if( s > min_height){
					$("#gotoTop").fadeIn(100);
				}else{
					$("#gotoTop").fadeOut(200);
				};
			});
		};
		gotoTop();

        $(function(){
            $('.home-follow').click(function(e){
                e.preventDefault();

                if($('.home-contact').is(':visible')){
                    $('.home-contact').slideUp(100);
                }else{
                    $('.home-contact').slideDown(100);
                }
            });
        })

    </script>
</body>
</html>
