<!DOCTYPE html>
<html xmlns:wb="http://open.weibo.com/wb">
<head>
    <!--   Author: NingG   -->
    <meta charset="utf-8" />
	<meta property="wb:webmaster" content="7ea7f3d5f3edad6a" />
    <title>Storm 0.9.2：如何从Kafka读取数据 | ningg.top</title>
    <meta name="author" content="NingG" />
    <meta name="renderer" content="webkit">
    <meta name="description" content=" Kafka可以作为消息队列，实现写数据采集与数据分析之间的解耦，Storm如何读取Kafka中的数据呢？  " />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">

    <link rel="stylesheet" href="/css/default.css" type="text/css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="alternate" type="application/atom+xml" title="Recent Entries" href="" />
	
    <script src="/js/jquery-1.7.1.min.js" type="text/javascript"></script>
	<script src="http://tjs.sjs.sinajs.cn/open/api/js/wb.js" type="text/javascript" charset="utf-8"></script>
	<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</head>
<body>
	
    <div class="home-menu">
        <div class="home-icon-con">
            <a class="home-menu-icon" href="/">NingG</a>
            <a class="home-follow" href="#" title="Contact Me">+</a>
        </div>
        <div class="home-contact">
            <a href="http://weibo.com/ggningg/" target="_blank" style="margin-left:-5px;"><img src="http://www.weibo.com/favicon.ico" alt="" width="25"/></a>
            <a href="http://www.douban.com/people/ggningg/" target="_blank" style="text-align:center;"><img src="http://www.douban.com/favicon.ico" alt="" width="22"/></a>
			<a href="http://github.com/ningg" alt="" target="_blank" style="text-align:right;"><img src="/images/icon-cube-smaller.png" width="22"/></a>
        </div>
    </div>

    <link rel="stylesheet" href="/js/prettify/prettify.css" />
<style type="text/css">
    body { background:#e8e8e8; }
    @media screen and (max-width: 750px){
        body { background:#fff; }
    }
    @media screen and (max-width: 1020px){
        body { background:#fff; }
    }
</style>

<div id="content">
    <div class="entry">
        <h1 class="entry-title"><a href="/storm-with-kafka" title="Storm 0.9.2：如何从Kafka读取数据">Storm 0.9.2：如何从Kafka读取数据</a></h1>
        <p class="entry-date">2014-10-31</p>
        <h2 id="section">背景</h2>

<p>之前研读了<a href="/in-stream-big-data-processing">In-Stream Big Data Processing</a>，组里将基于此实现一个实时的数据分析系统，基本选定三个组件：Flume、Kafka、Storm，其中，Flume负责数据采集，Kafka是一个MQ:负责数据采集与数据分析之间解耦，Storm负责进行流式处理。</p>

<p>把这3个东西串起来，可以吗？可以的，之前整理了<a href="/flume-with-kafka">Flume与Kafka整合</a>的文章，那Storm能够与Kafka整合吗？Storm官网有介绍：
<a href="http://storm.apache.org/about/integrates.html">Storm Integrates</a>，其中给出了Storm与Kafka集成的<a href="https://github.com/apache/incubator-storm/tree/master/external/storm-kafka">方案</a>。</p>

<h2 id="storm">回顾Storm</h2>

<p>之前都是以原文+注释方式，来阅读Storm的官方文档，现在集中整理一下。Storm集群的构成：</p>

<ul>
  <li>包含两种节点：master和worker；</li>
  <li>master上运行<code>Nimbus</code>，负责：distribute code、assign task、monitor failutes；</li>
  <li>worker上运行<code>Supervisor</code>，负责：监听<code>Nimbus</code>分配的任务，并启停worker precess；</li>
  <li>zookeeper负责协调<code>Nimbus</code>和<code>Supervisor</code>之间的关系，所有状态信息都存储在zookeeper or local host；因此，重启Nimbus or Supervisor进程，对用户来说无影响；</li>
</ul>

<p><img src="/images/storm-tutorial/storm-cluster.png" alt="" /></p>

<p>关于 spout 和 bolt ，说几点：</p>

<ul>
  <li>spout（龙卷风、气旋）： source of stream，向topology中拉入数据的原点；</li>
  <li>bolt（闪电）：处理 stream，通过run functions、filter tuples、do streaming aggregations、do streaming join、talk to database… 来做任何事情；</li>
  <li>topology：由spout、bolt以及他们之间的关系构成，是client提交给Storm cluster执行的基本单元；</li>
  <li>topology中所有node都是并发运行的，可以配置每个node的并发数；</li>
</ul>

<p><img src="/images/storm-tutorial/topology.png" alt="" /></p>

<p><strong>notes(ningg)</strong>：topology中node是什么概念？spout、bolt？master、worker？jvm process？thread？
<strong>RE</strong>：master、worker对应Storm的node，master负责控制，worker负责具体执行；spout、bolt是逻辑上的，并且分布在不同的worker上；每个spout、bolt可配置并发数，这个并发数对应启动的thread；不同的spout、bolt对应不同的thread，thread间不能共用；这些所有的thread由所有的worker process来执行，举例，累计300个thread，启动了30个worker，则平均每个worker process对应执行10个thread（前面的说法对吗？哈哈）</p>

<p>关于数据模型，即数据的结构，说几点：</p>

<ul>
  <li>Storm中，使用tuple结构来存储数据，tuple由fields构成，field可以为任意类型；</li>
  <li>topology中spout、bolt必须声明其emit的tuple格式：<code>declareOutputFields()</code>；</li>
  <li><code>setSpout</code>/<code>setBolt</code>用于定义spout和bolt，输入参数：node id、processing logic、amount of parallelism；</li>
  <li>processing logic对应类spout/bolt，需要implement <code>IRichSpout</code>/<code>IRichBolt</code>；</li>
</ul>

<p>Storm有两种执行模式，<code>local mode</code>和<code>distributed mode</code>，补充几点：</p>

<ul>
  <li>local mode，在本地的process中通过thread模拟worker，多用于testing和development topology；更多参考<a href="http://storm.apache.org/documentation/Local-mode.html">资料</a>；</li>
  <li>distributed mode，用户向master提交topology以及运行topology所需的所有code；master向worker分发topology；更多参考<a href="http://storm.apache.org/documentation/Running-topologies-on-a-production-cluster.html">资料</a>；</li>
</ul>

<p>关于Stream groupings，几点：</p>

<p>*　stream grouping解决的问题：多个执行spout逻辑的thread都输出tuple，这些tuple要发送给bolt对应的多个thread，问题来了，tuple发给bolt的哪个thread？即，stream grouping解决：tuple在不同task之间传递关系；
*　shuffle grouping，随机分发；field grouping，根据给定的field进行分发；更多<a href="http://storm.apache.org/documentation/Concepts.html">参考</a>；</p>

<p><img src="/images/storm-tutorial/topology-tasks.png" alt="" /></p>

<h2 id="stromkafka">Strom整合Kafka</h2>

<h3 id="section-1">版本信息</h3>

<p>Storm与Kafka的版本信息：</p>

<ul>
  <li>Storm：apache-storm-0.9.2-incubating</li>
  <li>Kafka：kafka_2.9.2-0.8.1.1.tgz</li>
</ul>

<h3 id="section-2">基础知识</h3>

<p>实现Storm读取Kafka中的数据，参考<a href="http://storm.apache.org/about/integrates.html">官网介绍</a>， 本部分主要参考自<a href="https://github.com/apache/incubator-storm/tree/master/external/storm-kafka">storm-kafka</a>的README。</p>

<p>Strom从Kafka中读取数据，本质：实现一个Storm中的Spout，来读取Kafka中的数据；这个Spout，可以称为Kafka Spout。实现一个Kafka Spout有两条路：</p>

<ul>
  <li>core storm spout；</li>
  <li>Trident spout；</li>
</ul>

<p>无论用哪种方式实现Kafka Spout，都分为两步走：</p>

<ul>
  <li>实现BrokerHost接口：用于记录Kafka broker host与partition之间的映射关系；具体两种实现方式：
    <ul>
      <li>ZkHosts类：从zookeeper中动态的获取kafka broker与partition之间的映射关系；初始化时，需要配置zookeeper的<code>ip:port</code>；默认，每60s从zookeeper中请求一次映射关系；</li>
      <li>StaticHosts类：当broker–partition之间的映射关系是静态时，常使用此方法；</li>
    </ul>
  </li>
  <li>继承KafkaConfig类：用于存储Kafka相关的参数；将上面实例的BrokerHost对象，作为参数传入KafkaConfig，例，Kafka的一个构造方法为<code>KafkaConfig(BrokerHosts hosts, String topic)</code>；当前其实现方式有两个：
    <ul>
      <li>SpoutConfig：Core KafkaSpout只接受此配置方式；</li>
      <li>TridentKafkaConfig：TridentKafkaEmitter只接受此配置方式；</li>
    </ul>
  </li>
</ul>

<p>KafkaConfig类中涉及到的配置参数默认值如下：</p>

<pre><code>public int fetchSizeBytes = 1024 * 1024;
public int socketTimeoutMs = 10000;
public int fetchMaxWait = 10000;
public int bufferSizeBytes = 1024 * 1024;
public MultiScheme scheme = new RawMultiScheme();
public boolean forceFromStart = false;
public long startOffsetTime = kafka.api.OffsetRequest.EarliestTime();
public long maxOffsetBehind = Long.MAX_VALUE;
public boolean useStartOffsetTimeIfOffsetOutOfRange = true;
public int metricsTimeBucketSizeInSecs = 60;
</code></pre>

<p>上面的MultiScheme类型的参数shceme，其负责：将Kafka中取出的byte[]转换为storm所需的tuple，这是一个扩展点，默认是原文输出。两种实现：<code>SchemeAsMultiScheme</code>和<code>KeyValueSchemeAsMultiScheme</code>可将读取的byte[]转换为String。</p>

<p><strong>notes(ningg)</strong>：几个疑问，列在下面了</p>

<ul>
  <li><code>ZkHosts</code>类的一个构造方法<code>ZkHosts(String brokerZkStr, String brokerZkPath)</code>，其中<code>brokerZkPath</code>的含义，原始给出的说法是：”rokerZkPath is the root directory under which all the topics and partition information is stored. by Default this is <code>/brokers</code> which is what default kafka implementation uses.”</li>
  <li><code>SpoutConfig(BrokerHosts hosts, String topic, String zkRoot, String id)</code>，其中，<code>zkRoot</code>是一个root目录，用于存储consumer的offset；那这个<code>zkRoot</code>对应的目录物理上在哪台机器？</li>
</ul>

<h3 id="section-3">配置实例</h3>

<h4 id="core-kafka-spout">Core Kafka Spout</h4>

<p>本质是设置一个读取Kafka中数据的Kafka Spout，然后，将从替换原始local mode下，topology中的Spout即可。下面是一个已经验证过的实例</p>

<pre><code>TopologyBuilder builder = new TopologyBuilder();

BrokerHosts hosts = new ZkHosts("121.7.2.12:2181");
SpoutConfig spoutConfig = new SpoutConfig(hosts, "ningg", "/" + "ningg", UUID.randomUUID().toString());
spoutConfig.scheme = new SchemeAsMultiScheme(new StringScheme());
KafkaSpout kafkaSpout = new KafkaSpout(spoutConfig);

// set Spout.
builder.setSpout("word", kafkaSpout, 3);
builder.setBolt("result", new ExclamationBolt(), 3).shuffleGrouping("word");

Config conf = new Config();
conf.setDebug(true);

// submit topology in local mode
LocalCluster cluster = new LocalCluster();
cluster.submitTopology("test", conf, builder.createTopology());
</code></pre>

<h3 id="trident-kafka-spouttodo">Trident Kafka Spout（todo）</h3>

<p>todo</p>

<p>下面的样例并还没验证：</p>

<pre><code>TridentTopology topology = new TridentTopology();
BrokerHosts zk = new ZkHosts("localhost");
TridentKafkaConfig spoutConf = new TridentKafkaConfig(zk, "test-topic");
spoutConf.scheme = new SchemeAsMultiScheme(new StringScheme());
OpaqueTridentKafkaSpout spout = new OpaqueTridentKafkaSpout(spoutConf);
</code></pre>

<h2 id="section-4">参考来源</h2>

<ul>
  <li><a href="http://storm.apache.org/about/integrates.html">Storm Integrates</a></li>
  <li><a href="https://github.com/apache/incubator-storm/tree/master/external/storm-kafka">storm-kafka</a></li>
</ul>



        <div id="disqus_container">
            <div style="margin-bottom:20px" class="right">
				<wb:share-button appkey="2306590132" addition="simple" type="button" ralateUid="2356527183"></wb:share-button>
            </div>
            <!--<a href="#" class="comment" onclick="return false;">点击查看评论</a>-->
            <div id="disqus_thread"></div>
        </div>
    </div>

	
    <div class="sidenav">
		<iframe width="100%" height="75" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=550&fansRow=2&ptype=1&speed=0&skin=1&isTitle=0&noborder=0&isWeibo=0&isFans=0&uid=2356527183&verifier=1ccfb61e&colors=d6f3f7,ffffff,666666,0082cb,ecfbfd&dpc=1"></iframe>
    </div>

</div>

<script src="/js/post.js" type="text/javascript"></script>


	<div id="gotoTop">Top</div>


    <!--*********************************************************-->
    <!--****** 宝贝儿，看见这个时候，删掉下面的统计代码哦~ ******-->
    <!--*********************************************************-->
	<script>
	  (function(i,s,o,g,r,a,m){
		  i['GoogleAnalyticsObject']=r;i[r]=i[r] || function(){
			(i[r].q=i[r].q||[]).push(arguments)}, i[r].l=1*new Date();
			a=s.createElement(o), m=s.getElementsByTagName(o)[0];
			a.async=1;
			a.src=g;
			m.parentNode.insertBefore(a,m)
	  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	  ga('create', 'UA-48535193-1', 'ningg.github.io');
	  ga('send', 'pageview');
	</script>
    
	
    <script type="text/javascript">
		function gotoTop(min_height){
			$("#gotoTop").click(
				function(){$('html,body').animate({scrollTop:0},700);
			}).hover(
				function(){$(this).addClass("hover");},
				function(){$(this).removeClass("hover");
			});
			min_height ? min_height = min_height : min_height = 600;
			$(window).scroll(function(){
				
				var s = $(window).scrollTop();
				
				if( s > min_height){
					$("#gotoTop").fadeIn(100);
				}else{
					$("#gotoTop").fadeOut(200);
				};
			});
		};
		gotoTop();

        $(function(){
            $('.home-follow').click(function(e){
                e.preventDefault();

                if($('.home-contact').is(':visible')){
                    $('.home-contact').slideUp(100);
                }else{
                    $('.home-contact').slideDown(100);
                }
            });
        })

    </script>
</body>
</html>
