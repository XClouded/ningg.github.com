<!DOCTYPE html>
<html xmlns:wb="http://open.weibo.com/wb">
<head>
    <!--   Author: NingG   -->
    <meta charset="utf-8" />
	<meta property="wb:webmaster" content="7ea7f3d5f3edad6a" />
    <title>MySQL事务隔离级别与MVCC | ningg.top</title>
    <meta name="author" content="NingG" />
    <meta name="renderer" content="webkit">
    <meta name="description" content=" 数据库支持事务，事务有隔离级别  " />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">

    <link rel="stylesheet" href="/css/default.css" type="text/css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="alternate" type="application/atom+xml" title="Recent Entries" href="" />
	
    <script src="/js/jquery-1.7.1.min.js" type="text/javascript"></script>
	<script src="http://tjs.sjs.sinajs.cn/open/api/js/wb.js" type="text/javascript" charset="utf-8"></script>
	<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</head>
<body>
	
    <div class="home-menu">
        <div class="home-icon-con">
            <a class="home-menu-icon" href="/">NingG</a>
            <a class="home-follow" href="#" title="Contact Me">+</a>
        </div>
        <div class="home-contact">
            <a href="http://weibo.com/ggningg/" target="_blank" style="margin-left:-5px;"><img src="http://www.weibo.com/favicon.ico" alt="" width="25"/></a>
            <a href="http://www.douban.com/people/ggningg/" target="_blank" style="text-align:center;"><img src="http://www.douban.com/favicon.ico" alt="" width="22"/></a>
			<a href="http://github.com/ningg" alt="" target="_blank" style="text-align:right;"><img src="/images/icon-cube-smaller.png" width="22"/></a>
        </div>
    </div>

    <link rel="stylesheet" href="/js/prettify/prettify.css" />
<style type="text/css">
    body { background:#e8e8e8; }
    @media screen and (max-width: 750px){
        body { background:#fff; }
    }
    @media screen and (max-width: 1020px){
        body { background:#fff; }
    }
</style>

<div id="content">
    <div class="entry">
        <h1 class="entry-title"><a href="/mysql-transaction" title="MySQL事务隔离级别与MVCC">MySQL事务隔离级别与MVCC</a></h1>
        <p class="entry-date">2012-05-16</p>
        <p>几点：</p>

<ul>
  <li>事务是什么？</li>
  <li>事务的几个特性/要求：ACID？</li>
  <li>隔离级别？</li>
  <li>MySQL中怎么支持事务的隔离级别的？</li>
  <li>MySQL中如何修改事务隔离级别？</li>
</ul>

<h2 id="section">事务是什么？</h2>

<p><strong>事务</strong>（Transaction），一组数据库操作，作为单个逻辑单元。</p>

<h2 id="section-1">几个特性</h2>

<p>事务具有4个属性：ACID，原子性、一致性、隔离性、持久性。</p>

<ul>
  <li>原子性（Atomicity）：不可分割的逻辑单元，事务中的操作要么都做、要么都不做；</li>
  <li>一致性（Consistency）：事务必须使数据库从一个一致性状态变到另一个一致性状态。例如，一次转账的事务操作，要求A账户转出的钱，等于B账户转入的钱，实际上，一致性，是具体业务场景的约束；</li>
  <li>隔离性（Isolation）：事务相互独立，互不干扰；</li>
  <li>持久性（Durability）：事务一旦提交，数据库的改变就是永久的，断电、故障都不会有影响；</li>
</ul>

<h2 id="section-2">隔离级别</h2>

<p>事务有隔离性（Isolation），并发事务间相互独立，互不干扰；几个要点：</p>

<ul>
  <li>基本目标：不同线程，发起并发事务，要实现不同线程操作数据时，不互相干扰；</li>
  <li>相互干扰：脏读、不可重复读、幻读；</li>
  <li>不同隔离级别，4种：
    <ul>
      <li>读取未提交；</li>
      <li>读取已提交：</li>
      <li>可重复读；</li>
      <li>序列化；</li>
    </ul>
  </li>
  <li>本质：数据库操作CRUD的<strong>并发效率</strong> vs. <strong>数据安全性</strong>（数据一致）。</li>
  <li>实现机制：锁</li>
</ul>

<h3 id="section-3">并发事务，相互干扰的现象</h3>

<p>并发事务，相互干扰的几类现象：</p>

<ul>
  <li>脏读：一个事务读取了另一个事务<strong>未提交的更新数据</strong>。（A和B事务并发执行，A改后还未提交，B读，A又改并提交或者回滚）。</li>
  <li>不可重复读：一个事务读到另一个事务<strong>已提交的更新数据</strong>（A和B事务并发执行，A先读，B再改，A再读）。</li>
  <li>幻读：一个事务读到另一个事务<strong>已提交的新插入的数据</strong>（A和B事务并发执行，A先读，A再改还未提交，B改其他，A再查）。
    <ul>
      <li>A把所有的“黑色”改为“白色”</li>
      <li>B插入一条新的数据“黑色”</li>
      <li>A再查询，还有“黑色”</li>
    </ul>
  </li>
</ul>

<h3 id="section-4">并发事务，隔离级别</h3>

<p>通过设定不同的隔离级别，来解决上述的脏读、不可重复读、幻读的现象，具体：</p>

<ul>
  <li>读取未提交（Read Uncommitted）：可以看到其他事务没有提交的数据，出现脏读、不可重复读、幻读；</li>
  <li>读取已提交（Read Committed）：只能看到其他事务已经提交的数据，避免了脏读，但存在不可重复读、幻读；</li>
  <li>可重复度（Repeatable Read）：事务A读取数据之后，对涉及的数据加锁，不允许其他事务进行修改，由于其他事务会插入新的数据，因此，会产生幻读；</li>
  <li>可序列化（Serializable）：事务一个接一个的执行，完全相互独立；</li>
</ul>

<p>Tips：</p>

<blockquote>
  <p>大部分数据库系统，默认隔离级别：读取已提交；MySQL默认，可重复读。</p>
</blockquote>

<p>不同隔离级别对应的现象，见下表：</p>

<table>
  <thead>
    <tr>
      <th>隔离级别</th>
      <th>脏读</th>
      <th>不可重复读</th>
      <th>幻读</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>读取未提交</td>
      <td>Y</td>
      <td>Y</td>
      <td>Y</td>
    </tr>
    <tr>
      <td>读取已提交</td>
      <td>N</td>
      <td>Y</td>
      <td>Y</td>
    </tr>
    <tr>
      <td>可重复读</td>
      <td>N</td>
      <td>N</td>
      <td>Y</td>
    </tr>
    <tr>
      <td>序列化</td>
      <td>N</td>
      <td>N</td>
      <td>N</td>
    </tr>
  </tbody>
</table>

<h2 id="mysql">MySQL中隔离级别</h2>

<p>隔离级别，用于表述<strong>并发事务</strong>之间的相互干扰程度，其基于<strong>锁机制</strong>进行并发控制。</p>

<h3 id="serializable">1. 可序列化 Serializable</h3>

<p>实现可序列化要求在<code>选定对象</code>上的<strong>读锁和写锁</strong>保持直到事务结束后才能释放。在 SELECT 的查询中使用一个 <code>WHERE 子句</code> 来描述一个范围时应该获得一个<strong>“范围锁(range-locks)”</strong>。这种机制可以避免“幻读(phantom reads)”现象。</p>

<h3 id="repeatable-read">2. 可重复读 Repeatable read</h3>

<p>该级别保证了同一个事务中<strong>多次读取同样的记录</strong>的结果是一致的。</p>

<p>对<code>选定对象</code>的<strong>读锁(read locks)和写锁(write locks)</strong>一直保持到事务结束，但不要求<strong>“范围锁(range-locks)”</strong>，因此可能会发生“幻读(phantom reads)”。</p>

<p>幻读：是因为没有保持<strong>范围锁</strong>，该事务执行了一个 where 子句的范围查询后，其他事务可能新增了一条处于该事务 where 查询范围内的记录，那么该事务再次执行范围查询时就会看到这些新增的记录行（幻行，Phantom row）。</p>

<p>可重复读是 MySQL 的默认事务隔离级别。</p>

<h3 id="read-committed">3. 读取已提交 Read committed</h3>

<p>DBMS需要对选定对象的<strong>写锁(write locks)</strong>一直保持到事务结束，但是读锁(read locks)在SELECT操作完成后马上释放（因此“不可重复读”现象可能会发生，见下面描述）。和前一种隔离级别一样，也不要求“范围锁(range-locks)”。</p>

<p>不可重复读是因为，事务只维持了选定对象的写锁，如果一些选定对象只涉及读锁，那么在读锁释放之后，其它事务可以对这些对象进行修改，该事务再次读取时就不一致了。例如，事务A对数据对象拥有<strong>写锁</strong>，事务B读取了数据对象，后事务A有对数据对象进行的更改并提交，事务B再次读取数据对象，两次读取结果不同。</p>

<p>大多数数据库的默认事务隔离级别都是这个。</p>

<h3 id="read-uncommitted">4. 未提交读 Read uncommitted</h3>

<p>也称为脏读（dirty read）。</p>

<p>一个事务可以读取到其它事务未提交的更改。</p>

<p>注意：</p>

<ul>
  <li><strong>不可重复读的重点是修改</strong>：同样的条件，读取过的数据，再次读取出来发现值不一样了。</li>
  <li><strong>幻读的重点在于新增或者删除</strong>：同样的条件，第 1 次和第 2 次读出来的记录数不一样。</li>
</ul>

<h2 id="mysql-1">MySQL中多版本并发控制</h2>

<p><strong>多版本并发控制（MVCC）</strong>的实现是通过保存数据在某个时间点的<strong>快照</strong>来实现的。根据事务的创建时间不同，每个事务对同一张表，同一时刻看到的数据可能是不一样的。</p>

<p>InnoDB 的 MVCC 是通过在每行记录后面保存两个隐藏的列来实现的：</p>

<ul>
  <li>行的<strong>创建时间</strong>；<em>（创建版本）</em></li>
  <li>行的<strong>过期时间</strong>（或<strong>删除时间</strong>）；<em>（删除版本）</em></li>
</ul>

<p>存储的实际值是<strong>系统版本号</strong>（system version number）。</p>

<p><strong>每开始一个新的事务，系统版本号都会递增</strong>。事务开始时刻的系统版本号作为事务的版本号，用来和查询到的每行记录的版本号进行比较。</p>

<p>在 <code>可重复读</code> 隔离级别下，MVCC 的具体操作：</p>

<ul>
  <li>select：InnoDB 要查找当前存在的行，并且当前未被删除的行，具体两个条件：
    <ul>
      <li><strong>创建版本号</strong>早于当前事务的创建版本号</li>
      <li><strong>删除版本号</strong>晚于当前事务的创建版本号 <em>（只有符合以上两个条件的记录，才能返回作为查询结果）</em></li>
    </ul>
  </li>
  <li>insert：InnoDB 新插入的行，<strong>创建版本号</strong> = 当前事务的创建版本号</li>
  <li>delete：InnoDB 删除的行，<strong>删除版本号</strong> = 当前事务的创建版本号</li>
  <li>update：InnoDB 实际插入新纪录，具体：
    <ul>
      <li>对于新纪录，<strong>创建版本号</strong> = 当前事务的创建版本号</li>
      <li>对于原纪录，<strong>删除版本号</strong> = 当前事务的创建版本号</li>
    </ul>
  </li>
</ul>

<h2 id="mysql-2">MySQL修改事务隔离级别</h2>

<p>todo:</p>

<ul>
  <li><a href="http://blog.itpub.net/195110/viewspace-1080777/">mysql修改事务隔离级别</a></li>
</ul>

<h2 id="section-5">参考来源</h2>

<ul>
  <li><a href="http://coderbee.net/index.php/db/20141020/1056">MySQL事务隔离级别</a></li>
  <li><a href="http://blog.itpub.net/195110/viewspace-1080777/">mysql修改事务隔离级别</a></li>
</ul>



        <div id="disqus_container">
            <div style="margin-bottom:20px" class="right">
				<wb:share-button appkey="2306590132" addition="simple" type="button" ralateUid="2356527183"></wb:share-button>
            </div>
            <!--<a href="#" class="comment" onclick="return false;">点击查看评论</a>-->
            <div id="disqus_thread"></div>
        </div>
    </div>

	
    <div class="sidenav">
		<iframe width="100%" height="75" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=550&fansRow=2&ptype=1&speed=0&skin=1&isTitle=0&noborder=0&isWeibo=0&isFans=0&uid=2356527183&verifier=1ccfb61e&colors=d6f3f7,ffffff,666666,0082cb,ecfbfd&dpc=1"></iframe>
    </div>

</div>

<script src="/js/post.js" type="text/javascript"></script>


	<div id="gotoTop">Top</div>


    <!--*********************************************************-->
    <!--****** 宝贝儿，看见这个时候，删掉下面的统计代码哦~ ******-->
    <!--*********************************************************-->
	<script>
	  (function(i,s,o,g,r,a,m){
		  i['GoogleAnalyticsObject']=r;i[r]=i[r] || function(){
			(i[r].q=i[r].q||[]).push(arguments)}, i[r].l=1*new Date();
			a=s.createElement(o), m=s.getElementsByTagName(o)[0];
			a.async=1;
			a.src=g;
			m.parentNode.insertBefore(a,m)
	  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	  ga('create', 'UA-48535193-1', 'ningg.github.io');
	  ga('send', 'pageview');
	</script>
    
	
    <script type="text/javascript">
		function gotoTop(min_height){
			$("#gotoTop").click(
				function(){$('html,body').animate({scrollTop:0},700);
			}).hover(
				function(){$(this).addClass("hover");},
				function(){$(this).removeClass("hover");
			});
			min_height ? min_height = min_height : min_height = 600;
			$(window).scroll(function(){
				
				var s = $(window).scrollTop();
				
				if( s > min_height){
					$("#gotoTop").fadeIn(100);
				}else{
					$("#gotoTop").fadeOut(200);
				};
			});
		};
		gotoTop();

        $(function(){
            $('.home-follow').click(function(e){
                e.preventDefault();

                if($('.home-contact').is(':visible')){
                    $('.home-contact').slideUp(100);
                }else{
                    $('.home-contact').slideDown(100);
                }
            });
        })

    </script>
</body>
</html>
