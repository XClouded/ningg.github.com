<!DOCTYPE html>
<html xmlns:wb="http://open.weibo.com/wb">
<head>
    <!--   Author: NingG   -->
    <meta charset="utf-8" />
	<meta property="wb:webmaster" content="7ea7f3d5f3edad6a" />
    <title>CentOS 6.4下LVM的使用 | ningg.top</title>
    <meta name="author" content="NingG" />
    <meta name="renderer" content="webkit">
    <meta name="description" content=" LVM，Logical Volume Management，逻辑卷管理，主要用于解决静态分区时，分区大小调整的问题  " />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">

    <link rel="stylesheet" href="/css/default.css" type="text/css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="alternate" type="application/atom+xml" title="Recent Entries" href="" />
	
    <script src="/js/jquery-1.7.1.min.js" type="text/javascript"></script>
	<script src="http://tjs.sjs.sinajs.cn/open/api/js/wb.js" type="text/javascript" charset="utf-8"></script>
	<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</head>
<body>
	
    <div class="home-menu">
        <div class="home-icon-con">
            <a class="home-menu-icon" href="/">NingG</a>
            <a class="home-follow" href="#" title="Contact Me">+</a>
        </div>
        <div class="home-contact">
            <a href="http://weibo.com/ggningg/" target="_blank" style="margin-left:-5px;"><img src="http://www.weibo.com/favicon.ico" alt="" width="25"/></a>
            <a href="http://www.douban.com/people/ggningg/" target="_blank" style="text-align:center;"><img src="http://www.douban.com/favicon.ico" alt="" width="22"/></a>
			<a href="http://github.com/ningg" alt="" target="_blank" style="text-align:right;"><img src="/images/icon-cube-smaller.png" width="22"/></a>
        </div>
    </div>

    <link rel="stylesheet" href="/js/prettify/prettify.css" />
<style type="text/css">
    body { background:#e8e8e8; }
    @media screen and (max-width: 750px){
        body { background:#fff; }
    }
    @media screen and (max-width: 1020px){
        body { background:#fff; }
    }
</style>

<div id="content">
    <div class="entry">
        <h1 class="entry-title"><a href="/use-lvm" title="CentOS 6.4下LVM的使用">CentOS 6.4下LVM的使用</a></h1>
        <p class="entry-date">2014-10-29</p>
        <h2 id="section">背景</h2>

<p>系统有9块盘，每个320GB，之前服务器（CentOS 6.3）上磁盘分配情况：选取一块盘作为系统盘，划分<code>/boot</code>、<code>swap</code>、<code>/</code>、<code>/home</code>；然后，将剩余的8块盘，逐个格式化，并mount到系统盘的某个目录下。现在的问题是：某系统要上线，需要一个足够大的空间来存储数据，如果使用上述的方案，每个目录最大的存储空间都只有320GB，还是不够大，今后可能面临分区扩容的问题，使用静态分区，扩容有些麻烦。而LVM（Logical Volume Management，逻辑卷管理）能够将多个磁盘/分区组合在一起，抽象为一个逻辑上的分区，即，利用LVM技术，8块盘可以组成一个2.5T大小的分区，这样问题就解决了。</p>

<p><strong>注意</strong>：上面利用LVM来管理8块盘的方案，只是初步想法，不是最终方案。</p>

<h2 id="lvm">LVM是什么</h2>

<p>LVM(Logical Volume Management，逻辑卷管理)，一大核心功能是：对磁盘分区进行动态管理。当前无论在Linux、类Unix以及其他Windowns操作系统上，都存在LVM管理软件。</p>

<p><img src="/images/use-lvm/lvm-arch.png" alt="" /></p>

<h3 id="lvm-1">LVM要解决的问题</h3>

<p>LVM要解决的典型问题：一块磁盘的空间160GB，其存满数据后，需要扩容，怎么办？传统静态分区时，需要将磁盘中近160GB的数据复制到1TB的磁盘上，然后，使用1TB的磁盘替换掉原来160GB的磁盘即可（替换：只要是挂载点替换一下就可以了）。LVM有更好的思路，来解决这个问题吗？</p>

<h3 id="lvm-2">LVM原理简介</h3>

<p>要解决上面磁盘空间不足时，磁盘的扩容问题，LVM提供了一个基本思路：LVM将底层的磁盘封装抽象为逻辑卷（logical volume），上层应用不直接从物理磁盘分区中读数据，而是从逻辑卷中读数据；LVM负责底层磁盘到逻辑卷的映射和管理；增加底层磁盘时，通过LVM可以为逻辑卷动态扩充容量，而这对上层应用是无影响的（透明的）。说这么多，总结一点：LVM提高了磁盘管理的灵活性。</p>

<h2 id="lvm-3">LVM原理详解</h2>

<p>上面简要说了一点点LVM的基本原理，吃饭要吃饱、做事要做好，OK，把LVM的原理好好理解一下。有几个概念要好好说一说。</p>

<h3 id="pv-physical-volume">PV: Physical Volume</h3>

<p>PV（Physical Volume），物理卷</p>

<ul>
  <li>物理卷在LVM系统中处于最底层。</li>
  <li>物理卷可以是整个硬盘、硬盘上的分区或从逻辑上与磁盘分区具有同样功能的设备（如：RAID）。</li>
  <li>物理卷是LVM的基本存储逻辑块，但和基本的物理存储介质（如分区、磁盘等）比较，却包含有与LVM相关的管理参数。</li>
</ul>

<p><strong>notes(ningg)</strong>：为什么要有PV？直接使用物理分区不行吗？</p>

<h3 id="vg-volume-group">VG: Volume Group</h3>

<p>VG（Volume Group），卷组</p>

<ul>
  <li>卷组建立在物理卷之上，它由一个或多个物理卷组成。</li>
  <li>卷组创建之后，可以动态地添加物理卷到卷组中，在卷组上可以创建一个或多个“LVM分区”（逻辑卷）。</li>
  <li>一个LVM系统中可以只有一个卷组，也可以包含多个卷组。</li>
  <li>LVM的卷组类似于非LVM系统中的物理硬盘。</li>
</ul>

<h3 id="lg-logical-volume">LG: Logical Volume</h3>

<p>LG（Logical Volume），逻辑卷</p>

<ul>
  <li>逻辑卷建立在卷组之上，它是从卷组中“切出”的一块空间。</li>
  <li>逻辑卷创建之后，其大小可以伸缩。</li>
  <li>LVM的逻辑卷类似于非LVM系统中的硬盘分区，在逻辑卷之上可以建立文件系统（比如，/home或者/usr等）。</li>
</ul>

<h3 id="pe-physical-extent">PE: Physical Extent</h3>

<p>PE（Physical Extent），物理区域，</p>

<ul>
  <li>每一个物理卷被划分为基本单元（称为PE），具有唯一编号的PE是可以被LVM寻址的最小存储单元。</li>
  <li>PE的大小可根据实际情况在创建物理卷时指定，默认为4 MB。</li>
  <li>PE的大小一旦确定将不能改变，同一个卷组中的所有物理卷的PE的大小需要一致。</li>
</ul>

<h3 id="le-logical-extent">LE: Logical Extent</h3>

<p>LE（Logical Extent），逻辑区域</p>

<ul>
  <li>逻辑区域也被划分为可被寻址的基本单位（称为LE）。</li>
  <li>在同一个卷组中，LE的大小和PE是相同的，并且一一对应。</li>
</ul>

<p><strong>notes(ningg)</strong>：PE、LE，是否与文件系统中block（逻辑块）类似？而block大，能够提升磁盘IO速度；但block过大，造成磁盘空间的浪费？</p>

<h3 id="vgda">VGDA</h3>

<p>和非LVM系统将包含分区信息的元数据保存在位于分区的起始位置的分区表中一样，逻辑卷以及卷组相关的元数据也是保存在位于物理卷起始处的卷组描述符区域（Volume Group Descriptor Area, VGDA）中。VGDA包括以下内容：PV描述符、VG描述符、LV描述符、和一些PE描述符。</p>

<p>注意：/boot分区不能位于卷组中，因为引导装载程序无法从逻辑卷中读取。如果你想把/分区放在逻辑卷上，必须创建一个与卷组分离的/boot分区。</p>

<h3 id="section-1">小结</h3>

<p>我们在创建好LV以后，我们会在 /dev 目录下看到我们的LV信息，例如 /dev/vgname/lvname， 我们每创建一个VG，其会在/dev目录下创建一个以该VG名字命名的文件夹，在该VG的基础上创建好LV以后，我们会在这个VG目录下多出一个以LV名字命名的逻辑卷。</p>

<p>下面我们来对整个LVM的工作原理进行一个总结：</p>

<ul>
  <li>物理磁盘/物理分区，被格式化为PV，本质：空间被划分为一个个的PE</li>
  <li>不同的PV加入到同一个VG中，不同PV的PE全部进入到了VG的PE池内</li>
  <li>LV基于PE创建，大小为PE的整数倍，组成LV的PE可能来自不同的物理磁盘</li>
  <li>LV现在就直接可以格式化后挂载使用了</li>
  <li>LV的扩充缩减实际上就是增加或减少组成该LV的PE数量，其过程不会丢失原始数据</li>
</ul>

<p><strong>notes(ningg)</strong>：在创建PV时，需要物理磁盘/物理分区提前进行格式化吗？<strong>RE</strong>：不需要格式化的，直接创建PV就行。</p>

<p><img src="/images/use-lvm/pv-vg-lv.jpg" alt="" /></p>

<h2 id="centosdoing">CentOS的推荐配置doing..</h2>

<p>使用LVM来管理磁盘时，CentOS有没有推荐的配置？</p>

<p>LVM只有优点吗？
LVM有没有副作用？降低磁盘IO？耗费一定的磁盘空间？LVM管理时，有没有CPU、磁盘资源的浪费？</p>

<p>（下面还没有修改，参考来源：<a href="http://hily.me/blog/2008/10/understanding-lvm/">理解 LVM (Logical Volume Manager)</a>）</p>

<p>是否使用 LVM？</p>

<p>在决定是否使用 LVM 前请先了解下 LVM 的优缺点。</p>

<p>使用 LVM 的优势：</p>

<ul>
  <li>文件系统可以跨多个磁盘，因此大小不会受物理磁盘的限制。</li>
  <li>可以在系统运行状态下动态地扩展文件系统大小。</li>
  <li>可以增加新磁盘到 LVM 的存储池中。</li>
  <li>可以以镜像的方式冗余重要数据到多个物理磁盘上。</li>
  <li>可以很方便地导出整个卷组，并导入到另外一台机器上。</li>
</ul>

<p>使用 LVM 的限制：</p>

<ul>
  <li>系统、文件系统出现问题时，LVM处理起来麻烦，关键要看处理者的能力</li>
  <li>在从卷组中移除一个磁盘时必须使用 reducevg，否则会出问题。</li>
  <li>当卷组中的一个磁盘损坏时，整个卷组都会受影响。</li>
  <li>不能减小文件系统大小（受文件系统类型限制）。</li>
  <li>因为加入了额外的操作，存储性能会受影响（使用 Stripe 的情况另当别论）。</li>
  <li>使用 LVM 将获得更好的可扩展性和可操作性，但却损失了可靠性和存储性能，总的说来就是在这两者间选择。</li>
</ul>

<p>使用要点</p>

<p>按需分配文件系统大小，不要一次性分配太大的空间给文件系统，剩余的空间可以放在存储池中，在需要时再扩充到文件系统中。
把不同的数据放在不同的卷组中，这样在做系统升级或数据迁移操作时会比较方便。</p>

<h2 id="linuxlvm">Linux下LVM命令</h2>

<p>LVM要实现的如下几个功能：</p>

<ul>
  <li>创建PV、VG、LV</li>
  <li>向VG中增加新的PV</li>
  <li>从VG中移除PV</li>
  <li>动态调整LV容量</li>
  <li>删除PV、VG、LV</li>
</ul>

<p><strong>notes(ningg)</strong>：LV本质由PE组成的，那一个LV对应的所有PE是均匀分布在PV上吗？有什么策略？</p>

<h3 id="pvvglv">PV\VG\LV的创建、删除</h3>

<p>来个表格吧：</p>

<table>
  <thead>
    <tr>
      <th>命令</th>
      <th>说明</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>pvcreate</code></td>
      <td>创建PV</td>
    </tr>
    <tr>
      <td><code>pvdisplay</code>/<code>pvs</code></td>
      <td>查询PV详情</td>
    </tr>
    <tr>
      <td><code>pvremove</code></td>
      <td>删除PV</td>
    </tr>
    <tr>
      <td><code>vgcreate</code></td>
      <td>创建VG</td>
    </tr>
    <tr>
      <td><code>vgdisplay</code>/<code>vgs</code></td>
      <td>查询VG详情</td>
    </tr>
    <tr>
      <td><code>vgremove</code></td>
      <td>删除VG</td>
    </tr>
    <tr>
      <td><code>lvcreate</code></td>
      <td>基于VG创建LV</td>
    </tr>
    <tr>
      <td><code>lvdisplay</code>/<code>lvs</code></td>
      <td>查询LV详情</td>
    </tr>
    <tr>
      <td><code>lvremove</code></td>
      <td>删除LV</td>
    </tr>
    <tr>
      <td><code>mkfs</code></td>
      <td>格式化LV</td>
    </tr>
    <tr>
      <td><code>mount</code></td>
      <td>挂载LV</td>
    </tr>
    <tr>
      <td><code>umount</code></td>
      <td>卸载LV</td>
    </tr>
  </tbody>
</table>

<p><strong>注意</strong>：先删除LV，再删除VG，最后删除PV。</p>

<h3 id="lvdoing">LV的动态调整doing…</h3>

<p>LV的动态调整：参考<a href="http://www.cnblogs.com/xiaoluo501395377/archive/2013/05/24/3097785.html">LVM逻辑卷的拉伸及缩减</a>，<a href="http://labs.chinamobile.com/mblog/854855_181800">简单理解LVM(Logical Volume Manager)的基本原理</a></p>

<h2 id="section-2">参考资料</h2>

<ul>
  <li><a href="http://blog.csdn.net/jimmy_zjw/article/details/8598219">什么是LVM?（CentOS 5）</a></li>
  <li><a href="http://www.cnblogs.com/xiaoluo501395377/archive/2013/05/22/3093405.html">LVM逻辑卷基本概念及LVM的工作原理</a></li>
  <li><a href="http://labs.chinamobile.com/mblog/854855_181800">简单理解LVM(Logical Volume Manager)的基本原理</a></li>
</ul>

<h2 id="section-3">杂谈</h2>

<p>我一直坚持读第一手的资料，因此，这次我直接就想到了CentOS官网的文章；不过读起来还是有些羞涩的，第一次接触LVM，很多东西云里雾里，相反查到的几篇blog还是不错的，有配图、有简洁的表述；因此，个人感觉，对于很生疏的东西，查看网上的blog反倒是入门的好方法；有了简单的入门知识，又希望深入理解的，那再去查第一手的资料就好了。</p>



        <div id="disqus_container">
            <div style="margin-bottom:20px" class="right">
				<wb:share-button appkey="2306590132" addition="simple" type="button" ralateUid="2356527183"></wb:share-button>
            </div>
            <!--<a href="#" class="comment" onclick="return false;">点击查看评论</a>-->
            <div id="disqus_thread"></div>
        </div>
    </div>

	
    <div class="sidenav">
		<iframe width="100%" height="75" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=550&fansRow=2&ptype=1&speed=0&skin=1&isTitle=0&noborder=0&isWeibo=0&isFans=0&uid=2356527183&verifier=1ccfb61e&colors=d6f3f7,ffffff,666666,0082cb,ecfbfd&dpc=1"></iframe>
    </div>

</div>

<script src="/js/post.js" type="text/javascript"></script>


	<div id="gotoTop">Top</div>


    <!--*********************************************************-->
    <!--****** 宝贝儿，看见这个时候，删掉下面的统计代码哦~ ******-->
    <!--*********************************************************-->
	<script>
	  (function(i,s,o,g,r,a,m){
		  i['GoogleAnalyticsObject']=r;i[r]=i[r] || function(){
			(i[r].q=i[r].q||[]).push(arguments)}, i[r].l=1*new Date();
			a=s.createElement(o), m=s.getElementsByTagName(o)[0];
			a.async=1;
			a.src=g;
			m.parentNode.insertBefore(a,m)
	  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	  ga('create', 'UA-48535193-1', 'ningg.github.io');
	  ga('send', 'pageview');
	</script>
    
	
    <script type="text/javascript">
		function gotoTop(min_height){
			$("#gotoTop").click(
				function(){$('html,body').animate({scrollTop:0},700);
			}).hover(
				function(){$(this).addClass("hover");},
				function(){$(this).removeClass("hover");
			});
			min_height ? min_height = min_height : min_height = 600;
			$(window).scroll(function(){
				
				var s = $(window).scrollTop();
				
				if( s > min_height){
					$("#gotoTop").fadeIn(100);
				}else{
					$("#gotoTop").fadeOut(200);
				};
			});
		};
		gotoTop();

        $(function(){
            $('.home-follow').click(function(e){
                e.preventDefault();

                if($('.home-contact').is(':visible')){
                    $('.home-contact').slideUp(100);
                }else{
                    $('.home-contact').slideDown(100);
                }
            });
        })

    </script>
</body>
</html>
